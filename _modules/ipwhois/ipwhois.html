<!DOCTYPE html>


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>ipwhois.ipwhois &mdash; ipwhois 0.10.1 documentation</title>
    
    <link rel="stylesheet" href="../../_static/basic.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/bootswatch-3.2.0/cosmo/bootstrap.min.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/bootstrap-sphinx.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '0.10.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/js/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="../../_static/js/jquery-fix.js"></script>
    <script type="text/javascript" src="../../_static/bootstrap-3.2.0/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="../../_static/bootstrap-sphinx.js"></script>
    <link rel="top" title="ipwhois 0.10.1 documentation" href="../../index.html" />
    <link rel="up" title="Module code" href="../index.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">

  </head>
  <body role="document">

  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../../index.html">
          ipwhois</a>
        <span class="navbar-text navbar-version pull-left"><b>0.10.1</b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../../index.html">ipwhois <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><ul>
<li class="toctree-l1"><a class="reference internal" href="../../README.html">Description</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../README.html#features">Features</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../README.html#links">Links</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../README.html#documentation">Documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../README.html#github">Github</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../README.html#pypi">Pypi</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../README.html#usage-examples">Usage Examples</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../README.html#typical-usage">Typical usage</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../README.html#multiple-networks-listed-and-referral-whois">Multiple networks listed and referral whois</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../README.html#whois-lookup-via-http-rest">Whois lookup via HTTP (REST)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../README.html#use-a-proxy">Use a proxy</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../README.html#retrieve-host-information-for-an-ip-address">Retrieve host information for an IP address</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../README.html#retrieve-the-official-country-name-for-an-iso-3166-1-country-code">Retrieve the official country name for an ISO 3166-1 country code</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../README.html#parse-out-ip-addresses-and-ports-from-text-or-a-file">Parse out IP addresses and ports from text or a file</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../README.html#dependencies">Dependencies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../README.html#installing">Installing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../README.html#parsing">Parsing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../README.html#rest-http">REST (HTTP)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../README.html#country-codes">Country Codes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../README.html#ip-reputation-support">IP Reputation Support?</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../README.html#domain-support">Domain Support?</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../README.html#special-thanks">Special Thanks</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../LICENSE.html">License</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../CHANGES.html">Changelog</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../CHANGES.html#id1">0.10.1 (2015-02-09)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../CHANGES.html#id2">0.10.0 (2015-02-09)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../CHANGES.html#id3">0.9.1 (2014-10-14)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../CHANGES.html#id4">0.9.0 (2014-07-27)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../CHANGES.html#id5">0.8.2 (2014-05-12)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../CHANGES.html#id6">0.8.1 (2014-03-05)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../CHANGES.html#id7">0.8.0 (2014-02-18)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../CHANGES.html#id8">0.7.0 (2014-01-14)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../CHANGES.html#id9">0.6.0 (2014-01-13)</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../CHANGES.old.html">Changelog (Archive)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../CHANGES.old.html#id1">0.5.2 (2013-12-07)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../CHANGES.old.html#id2">0.5.1 (2013-12-03)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../CHANGES.old.html#id3">0.5.0 (2013-11-20)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../CHANGES.old.html#id4">0.4.0 (2013-10-17)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../CHANGES.old.html#id5">0.3.0 (2013-09-30)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../CHANGES.old.html#id6">0.2.1 (2013-09-27)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../CHANGES.old.html#id7">0.2.0 (2013-09-23)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../CHANGES.old.html#id8">0.1.9 (2013-09-18)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../CHANGES.old.html#id9">0.1.8 (2013-09-17)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../CHANGES.old.html#id10">0.1.7 (2013-09-16)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../CHANGES.old.html#id11">0.1.6 (2013-09-16)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../CHANGES.old.html#id12">0.1.5 (2013-09-13)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../CHANGES.old.html#id13">0.1.4 (2013-09-12)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../CHANGES.old.html#id14">0.1.3 (2013-09-11)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../CHANGES.old.html#id15">0.1.2 (2013-09-10)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../CHANGES.old.html#id16">0.1.1 (2013-09-09)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../CHANGES.old.html#id17">0.1.0 (2013-09-06)</a></li>
</ul>
</li>
</ul>
</ul>
</li>
              
                <li class="dropdown">
  <a role="button"
     id="dLabelLocalToc"
     data-toggle="dropdown"
     data-target="#"
     href="#">Page <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"
      role="menu"
      aria-labelledby="dLabelLocalToc"></ul>
</li>
              
            
            
              
                
              
            
            
            
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    <div class="col-md-12">
      
  <h1>Source code for ipwhois.ipwhois</h1><div class="highlight"><pre>
<span class="c"># Copyright (c) 2013, 2014, 2015 Philip Hane</span>
<span class="c"># All rights reserved.</span>
<span class="c">#</span>
<span class="c"># Redistribution and use in source and binary forms, with or without</span>
<span class="c"># modification, are permitted provided that the following conditions are met:</span>
<span class="c">#</span>
<span class="c"># 1. Redistributions of source code must retain the above copyright notice,</span>
<span class="c">#    this list of conditions and the following disclaimer.</span>
<span class="c"># 2. Redistributions in binary form must reproduce the above copyright notice,</span>
<span class="c">#    this list of conditions and the following disclaimer in the documentation</span>
<span class="c">#    and/or other materials provided with the distribution.</span>
<span class="c">#</span>
<span class="c"># THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS IS&quot;</span>
<span class="c"># AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE</span>
<span class="c"># IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE</span>
<span class="c"># ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE</span>
<span class="c"># LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR</span>
<span class="c"># CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF</span>
<span class="c"># SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS</span>
<span class="c"># INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN</span>
<span class="c"># CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)</span>
<span class="c"># ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE</span>
<span class="c"># POSSIBILITY OF SUCH DAMAGE.</span>

<span class="kn">import</span> <span class="nn">sys</span>

<span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">ipaddress</span> <span class="kn">import</span> <span class="p">(</span><span class="n">ip_address</span><span class="p">,</span>
                       <span class="n">IPv4Address</span><span class="p">,</span>
                       <span class="n">IPv6Address</span><span class="p">,</span>
                       <span class="n">ip_network</span><span class="p">,</span>
                       <span class="n">summarize_address_range</span><span class="p">,</span>
                       <span class="n">collapse_addresses</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">ipaddr</span> <span class="kn">import</span> <span class="p">(</span><span class="n">IPAddress</span> <span class="k">as</span> <span class="n">ip_address</span><span class="p">,</span>
                        <span class="n">IPv4Address</span><span class="p">,</span>
                        <span class="n">IPv6Address</span><span class="p">,</span>
                        <span class="n">IPNetwork</span> <span class="k">as</span> <span class="n">ip_network</span><span class="p">,</span>
                        <span class="n">summarize_address_range</span><span class="p">,</span>
                        <span class="n">collapse_address_list</span> <span class="k">as</span> <span class="n">collapse_addresses</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">dns.resolver</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">ipv4_is_defined</span><span class="p">,</span> <span class="n">ipv6_is_defined</span><span class="p">,</span> <span class="n">unique_everseen</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">urllib.request</span> <span class="kn">import</span> <span class="p">(</span><span class="n">OpenerDirector</span><span class="p">,</span>
                                <span class="n">ProxyHandler</span><span class="p">,</span>
                                <span class="n">build_opener</span><span class="p">,</span>
                                <span class="n">Request</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">urllib2</span> <span class="kn">import</span> <span class="p">(</span><span class="n">OpenerDirector</span><span class="p">,</span>
                         <span class="n">ProxyHandler</span><span class="p">,</span>
                         <span class="n">build_opener</span><span class="p">,</span>
                         <span class="n">Request</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">sleep</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>

<span class="c">#Import the dnspython3 rdtypes to fix the dynamic import problem when frozen.</span>
<span class="kn">import</span> <span class="nn">dns.rdtypes.ANY.TXT</span>  <span class="c"># @UnusedImport</span>

<span class="n">IETF_RFC_REFERENCES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="c">#IPv4</span>
    <span class="s">&#39;RFC 1122, Section 3.2.1.3&#39;</span><span class="p">:</span>
    <span class="s">&#39;http://tools.ietf.org/html/rfc1122#section-3.2.1.3&#39;</span><span class="p">,</span>
    <span class="s">&#39;RFC 1918&#39;</span><span class="p">:</span> <span class="s">&#39;http://tools.ietf.org/html/rfc1918&#39;</span><span class="p">,</span>
    <span class="s">&#39;RFC 3927&#39;</span><span class="p">:</span> <span class="s">&#39;http://tools.ietf.org/html/rfc3927&#39;</span><span class="p">,</span>
    <span class="s">&#39;RFC 5736&#39;</span><span class="p">:</span> <span class="s">&#39;http://tools.ietf.org/html/rfc5736&#39;</span><span class="p">,</span>
    <span class="s">&#39;RFC 5737&#39;</span><span class="p">:</span> <span class="s">&#39;http://tools.ietf.org/html/rfc5737&#39;</span><span class="p">,</span>
    <span class="s">&#39;RFC 3068&#39;</span><span class="p">:</span> <span class="s">&#39;http://tools.ietf.org/html/rfc3068&#39;</span><span class="p">,</span>
    <span class="s">&#39;RFC 2544&#39;</span><span class="p">:</span> <span class="s">&#39;http://tools.ietf.org/html/rfc2544&#39;</span><span class="p">,</span>
    <span class="s">&#39;RFC 3171&#39;</span><span class="p">:</span> <span class="s">&#39;http://tools.ietf.org/html/rfc3171&#39;</span><span class="p">,</span>
    <span class="s">&#39;RFC 919, Section 7&#39;</span><span class="p">:</span> <span class="s">&#39;http://tools.ietf.org/html/rfc919#section-7&#39;</span><span class="p">,</span>
    <span class="c">#IPv6</span>
    <span class="s">&#39;RFC 4291, Section 2.7&#39;</span><span class="p">:</span> <span class="s">&#39;http://tools.ietf.org/html/rfc4291#section-2.7&#39;</span><span class="p">,</span>
    <span class="s">&#39;RFC 4291&#39;</span><span class="p">:</span> <span class="s">&#39;http://tools.ietf.org/html/rfc4291&#39;</span><span class="p">,</span>
    <span class="s">&#39;RFC 4291, Section 2.5.2&#39;</span><span class="p">:</span>
    <span class="s">&#39;http://tools.ietf.org/html/rfc4291#section-2.5.2&#39;</span><span class="p">,</span>
    <span class="s">&#39;RFC 4291, Section 2.5.3&#39;</span><span class="p">:</span>
    <span class="s">&#39;http://tools.ietf.org/html/rfc4291#section-2.5.3&#39;</span><span class="p">,</span>
    <span class="s">&#39;RFC 4291, Section 2.5.6&#39;</span><span class="p">:</span>
    <span class="s">&#39;http://tools.ietf.org/html/rfc4291#section-2.5.6&#39;</span><span class="p">,</span>
    <span class="s">&#39;RFC 4291, Section 2.5.7&#39;</span><span class="p">:</span>
    <span class="s">&#39;http://tools.ietf.org/html/rfc4291#section-2.5.7&#39;</span><span class="p">,</span>
    <span class="s">&#39;RFC 4193&#39;</span><span class="p">:</span> <span class="s">&#39;https://tools.ietf.org/html/rfc4193&#39;</span>
<span class="p">}</span>

<span class="n">NIC_WHOIS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">&#39;arin&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s">&#39;server&#39;</span><span class="p">:</span> <span class="s">&#39;whois.arin.net&#39;</span><span class="p">,</span>
        <span class="s">&#39;url&#39;</span><span class="p">:</span> <span class="p">(</span>
            <span class="s">&#39;http://whois.arin.net/rest/nets;q={0}?&#39;</span>
            <span class="s">&#39;showDetails=true&amp;showARIN=true&#39;</span>
        <span class="p">),</span>
        <span class="s">&#39;fields&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s">&#39;name&#39;</span><span class="p">:</span> <span class="s">r&#39;(NetName):[^\S\n]+(?P&lt;val&gt;.+?)\n&#39;</span><span class="p">,</span>
            <span class="s">&#39;handle&#39;</span><span class="p">:</span> <span class="s">r&#39;(NetHandle):[^\S\n]+(?P&lt;val&gt;.+?)\n&#39;</span><span class="p">,</span>
            <span class="s">&#39;description&#39;</span><span class="p">:</span> <span class="s">r&#39;(OrgName|CustName):[^\S\n]+(?P&lt;val&gt;.+?)&#39;</span>
                    <span class="s">&#39;(?=(</span><span class="se">\n</span><span class="s">\S):?)&#39;</span><span class="p">,</span>
            <span class="s">&#39;country&#39;</span><span class="p">:</span> <span class="s">r&#39;(Country):[^\S\n]+(?P&lt;val&gt;.+?)\n&#39;</span><span class="p">,</span>
            <span class="s">&#39;state&#39;</span><span class="p">:</span> <span class="s">r&#39;(StateProv):[^\S\n]+(?P&lt;val&gt;.+?)\n&#39;</span><span class="p">,</span>
            <span class="s">&#39;city&#39;</span><span class="p">:</span> <span class="s">r&#39;(City):[^\S\n]+(?P&lt;val&gt;.+?)\n&#39;</span><span class="p">,</span>
            <span class="s">&#39;address&#39;</span><span class="p">:</span> <span class="s">r&#39;(Address):[^\S\n]+(?P&lt;val&gt;.+?)(?=(\n\S):?)&#39;</span><span class="p">,</span>
            <span class="s">&#39;postal_code&#39;</span><span class="p">:</span> <span class="s">r&#39;(PostalCode):[^\S\n]+(?P&lt;val&gt;.+?)\n&#39;</span><span class="p">,</span>
            <span class="s">&#39;abuse_emails&#39;</span><span class="p">:</span> <span class="s">r&#39;(OrgAbuseEmail):[^\S\n]+(?P&lt;val&gt;.+?)\n&#39;</span><span class="p">,</span>
            <span class="s">&#39;tech_emails&#39;</span><span class="p">:</span> <span class="s">r&#39;(OrgTechEmail):[^\S\n]+(?P&lt;val&gt;.+?)\n&#39;</span><span class="p">,</span>
            <span class="s">&#39;created&#39;</span><span class="p">:</span> <span class="s">r&#39;(RegDate):[^\S\n]+(?P&lt;val&gt;.+?)\n&#39;</span><span class="p">,</span>
            <span class="s">&#39;updated&#39;</span><span class="p">:</span> <span class="s">r&#39;(Updated):[^\S\n]+(?P&lt;val&gt;.+?)\n&#39;</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="s">&#39;dt_format&#39;</span><span class="p">:</span> <span class="s">&#39;%Y-%m-</span><span class="si">%d</span><span class="s">&#39;</span><span class="p">,</span>
        <span class="s">&#39;dt_rws_format&#39;</span><span class="p">:</span> <span class="s">&#39;%Y-%m-</span><span class="si">%d</span><span class="s">T%H:%M:%S%z&#39;</span>
    <span class="p">},</span>
    <span class="s">&#39;ripencc&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s">&#39;server&#39;</span><span class="p">:</span> <span class="s">&#39;whois.ripe.net&#39;</span><span class="p">,</span>
        <span class="s">&#39;url&#39;</span><span class="p">:</span> <span class="s">&#39;http://rest.db.ripe.net/search.json?query-string={0}&#39;</span><span class="p">,</span>
        <span class="s">&#39;fields&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s">&#39;name&#39;</span><span class="p">:</span> <span class="s">r&#39;(netname):[^\S\n]+(?P&lt;val&gt;.+?)\n&#39;</span><span class="p">,</span>
            <span class="s">&#39;handle&#39;</span><span class="p">:</span> <span class="s">r&#39;(nic-hdl):[^\S\n]+(?P&lt;val&gt;.+?)\n&#39;</span><span class="p">,</span>
            <span class="s">&#39;description&#39;</span><span class="p">:</span> <span class="s">r&#39;(descr):[^\S\n]+(?P&lt;val&gt;.+?)(?=(\n\S):?)&#39;</span><span class="p">,</span>
            <span class="s">&#39;country&#39;</span><span class="p">:</span> <span class="s">r&#39;(country):[^\S\n]+(?P&lt;val&gt;.+?)\n&#39;</span><span class="p">,</span>
            <span class="s">&#39;address&#39;</span><span class="p">:</span> <span class="s">r&#39;(address):[^\S\n]+(?P&lt;val&gt;.+?)(?=(\n\S):?)&#39;</span><span class="p">,</span>
            <span class="s">&#39;abuse_emails&#39;</span><span class="p">:</span> <span class="p">(</span>
                <span class="s">r&#39;(abuse-mailbox:[^\S\n]+(?P&lt;val&gt;.+?))\n|(((?!abuse-mailbox).+&#39;</span>
                <span class="s">&#39;?:.*?[^\S</span><span class="se">\n</span><span class="s">]+(?P&lt;val2&gt;[\w\-\.]*abuse[\w\-\.]*@[\w\-\.]+\.&#39;</span>
                <span class="s">&#39;[\w\-]+)([^\S</span><span class="se">\n</span><span class="s">]+.*?)*?)</span><span class="se">\n</span><span class="s">)&#39;</span>
            <span class="p">),</span>
            <span class="s">&#39;misc_emails&#39;</span><span class="p">:</span> <span class="p">(</span>
                <span class="s">r&#39;(?!abuse-mailbox).+?:.*?[^\S\n]+(?P&lt;val&gt;(?!abuse)[\w\-\.]+?@&#39;</span>
                <span class="s">&#39;[\w\-\.]+\.[\w\-]+)([^\S</span><span class="se">\n</span><span class="s">]+.*?)*?</span><span class="se">\n</span><span class="s">&#39;</span>
            <span class="p">)</span>
        <span class="p">}</span>
    <span class="p">},</span>
    <span class="s">&#39;apnic&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s">&#39;server&#39;</span><span class="p">:</span> <span class="s">&#39;whois.apnic.net&#39;</span><span class="p">,</span>
        <span class="s">&#39;url&#39;</span><span class="p">:</span> <span class="s">&#39;http://rdap.apnic.net/ip/{0}&#39;</span><span class="p">,</span>
        <span class="s">&#39;fields&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s">&#39;name&#39;</span><span class="p">:</span> <span class="s">r&#39;(netname):[^\S\n]+(?P&lt;val&gt;.+?)\n&#39;</span><span class="p">,</span>
            <span class="s">&#39;handle&#39;</span><span class="p">:</span> <span class="s">r&#39;(nic-hdl):[^\S\n]+(?P&lt;val&gt;.+?)\n&#39;</span><span class="p">,</span>
            <span class="s">&#39;description&#39;</span><span class="p">:</span> <span class="s">r&#39;(descr):[^\S\n]+(?P&lt;val&gt;.+?)(?=(\n\S):?)&#39;</span><span class="p">,</span>
            <span class="s">&#39;country&#39;</span><span class="p">:</span> <span class="s">r&#39;(country):[^\S\n]+(?P&lt;val&gt;.+?)\n&#39;</span><span class="p">,</span>
            <span class="s">&#39;address&#39;</span><span class="p">:</span> <span class="s">r&#39;(address):[^\S\n]+(?P&lt;val&gt;.+?)(?=(\n\S):?)&#39;</span><span class="p">,</span>
            <span class="s">&#39;abuse_emails&#39;</span><span class="p">:</span> <span class="p">(</span>
                <span class="s">r&#39;(abuse-mailbox:[^\S\n]+(?P&lt;val&gt;.+?))\n|(((?!abuse-mailbox).+&#39;</span>
                <span class="s">&#39;?:.*?[^\S</span><span class="se">\n</span><span class="s">]+(?P&lt;val2&gt;[\w\-\.]*abuse[\w\-\.]*@[\w\-\.]+\.&#39;</span>
                <span class="s">&#39;[\w\-]+)([^\S</span><span class="se">\n</span><span class="s">]+.*?)*?)</span><span class="se">\n</span><span class="s">)&#39;</span>
            <span class="p">),</span>
            <span class="s">&#39;misc_emails&#39;</span><span class="p">:</span> <span class="p">(</span>
                <span class="s">r&#39;(?!abuse-mailbox).+?:.*?[^\S\n]+(?P&lt;val&gt;(?!abuse)[\w\-\.]+?@&#39;</span>
                <span class="s">&#39;[\w\-\.]+\.[\w\-]+)([^\S</span><span class="se">\n</span><span class="s">]+.*?)*?</span><span class="se">\n</span><span class="s">&#39;</span>
            <span class="p">),</span>
            <span class="s">&#39;updated&#39;</span><span class="p">:</span> <span class="s">r&#39;(changed):[^\S\n]+.*?(?P&lt;val&gt;[0-9]{8}).*?\n&#39;</span>
        <span class="p">},</span>
        <span class="s">&#39;dt_format&#39;</span><span class="p">:</span> <span class="s">&#39;%Y%m</span><span class="si">%d</span><span class="s">&#39;</span><span class="p">,</span>
        <span class="s">&#39;dt_rws_format&#39;</span><span class="p">:</span> <span class="s">&#39;%Y-%m-</span><span class="si">%d</span><span class="s">T%H:%M:%S%z&#39;</span>
    <span class="p">},</span>
    <span class="s">&#39;lacnic&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s">&#39;server&#39;</span><span class="p">:</span> <span class="s">&#39;whois.lacnic.net&#39;</span><span class="p">,</span>
        <span class="s">&#39;url&#39;</span><span class="p">:</span> <span class="s">&#39;http://restfulwhoisv2.labs.lacnic.net/restfulwhois/ip/{0}&#39;</span><span class="p">,</span>
        <span class="s">&#39;fields&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s">&#39;handle&#39;</span><span class="p">:</span> <span class="s">r&#39;(nic-hdl):[^\S\n]+(?P&lt;val&gt;.+?)\n&#39;</span><span class="p">,</span>
            <span class="s">&#39;description&#39;</span><span class="p">:</span> <span class="s">r&#39;(owner):[^\S\n]+(?P&lt;val&gt;.+?)(?=(\n\S):?)&#39;</span><span class="p">,</span>
            <span class="s">&#39;country&#39;</span><span class="p">:</span> <span class="s">r&#39;(country):[^\S\n]+(?P&lt;val&gt;.+?)\n&#39;</span><span class="p">,</span>
            <span class="s">&#39;abuse_emails&#39;</span><span class="p">:</span> <span class="p">(</span>
                <span class="s">r&#39;(abuse-mailbox:[^\S\n]+(?P&lt;val&gt;.+?))\n|(((?!abuse-mailbox).+&#39;</span>
                <span class="s">&#39;?:.*?[^\S</span><span class="se">\n</span><span class="s">]+(?P&lt;val2&gt;[\w\-\.]*abuse[\w\-\.]*@[\w\-\.]+\.&#39;</span>
                <span class="s">&#39;[\w\-]+)([^\S</span><span class="se">\n</span><span class="s">]+.*?)*?)</span><span class="se">\n</span><span class="s">)&#39;</span>
            <span class="p">),</span>
            <span class="s">&#39;misc_emails&#39;</span><span class="p">:</span> <span class="p">(</span>
                <span class="s">r&#39;(?!abuse-mailbox).+?:.*?[^\S\n]+(?P&lt;val&gt;(?!abuse)[\w\-\.]+?@&#39;</span>
                <span class="s">&#39;[\w\-\.]+\.[\w\-]+)([^\S</span><span class="se">\n</span><span class="s">]+.*?)*?</span><span class="se">\n</span><span class="s">&#39;</span>
            <span class="p">),</span>
            <span class="s">&#39;created&#39;</span><span class="p">:</span> <span class="s">r&#39;(created):[^\S\n]+(?P&lt;val&gt;[0-9]{8}).*?\n&#39;</span><span class="p">,</span>
            <span class="s">&#39;updated&#39;</span><span class="p">:</span> <span class="s">r&#39;(changed):[^\S\n]+(?P&lt;val&gt;[0-9]{8}).*?\n&#39;</span>
        <span class="p">},</span>
        <span class="s">&#39;dt_format&#39;</span><span class="p">:</span> <span class="s">&#39;%Y%m</span><span class="si">%d</span><span class="s">&#39;</span><span class="p">,</span>
        <span class="s">&#39;dt_rws_format&#39;</span><span class="p">:</span> <span class="s">&#39;%Y%m</span><span class="si">%d</span><span class="s">&#39;</span>
    <span class="p">},</span>
    <span class="s">&#39;afrinic&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s">&#39;server&#39;</span><span class="p">:</span> <span class="s">&#39;whois.afrinic.net&#39;</span><span class="p">,</span>
        <span class="s">&#39;url&#39;</span><span class="p">:</span> <span class="s">&#39;http://rest.db.ripe.net/search.json?query-string={0}&#39;</span><span class="p">,</span>
        <span class="s">&#39;fields&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s">&#39;name&#39;</span><span class="p">:</span> <span class="s">r&#39;(netname):[^\S\n]+(?P&lt;val&gt;.+?)\n&#39;</span><span class="p">,</span>
            <span class="s">&#39;handle&#39;</span><span class="p">:</span> <span class="s">r&#39;(nic-hdl):[^\S\n]+(?P&lt;val&gt;.+?)\n&#39;</span><span class="p">,</span>
            <span class="s">&#39;description&#39;</span><span class="p">:</span> <span class="s">r&#39;(descr):[^\S\n]+(?P&lt;val&gt;.+?)(?=(\n\S):?)&#39;</span><span class="p">,</span>
            <span class="s">&#39;country&#39;</span><span class="p">:</span> <span class="s">r&#39;(country):[^\S\n]+(?P&lt;val&gt;.+?)\n&#39;</span><span class="p">,</span>
            <span class="s">&#39;address&#39;</span><span class="p">:</span> <span class="s">r&#39;(address):[^\S\n]+(?P&lt;val&gt;.+?)(?=(\n\S):?)&#39;</span><span class="p">,</span>
            <span class="s">&#39;abuse_emails&#39;</span><span class="p">:</span> <span class="p">(</span>
                <span class="s">r&#39;(abuse-mailbox:[^\S\n]+(?P&lt;val&gt;.+?))\n|(((?!abuse-mailbox).+&#39;</span>
                <span class="s">&#39;?:.*?[^\S</span><span class="se">\n</span><span class="s">]+(?P&lt;val2&gt;[\w\-\.]*abuse[\w\-\.]*@[\w\-\.]+\.&#39;</span>
                <span class="s">&#39;[\w\-]+)([^\S</span><span class="se">\n</span><span class="s">]+.*?)*?)</span><span class="se">\n</span><span class="s">)&#39;</span>
            <span class="p">),</span>
            <span class="s">&#39;misc_emails&#39;</span><span class="p">:</span> <span class="p">(</span>
                <span class="s">r&#39;(?!abuse-mailbox).+?:.*?[^\S\n]+(?P&lt;val&gt;(?!abuse)[\w\-\.]+?@&#39;</span>
                <span class="s">&#39;[\w\-\.]+\.[\w\-]+)([^\S</span><span class="se">\n</span><span class="s">]+.*?)*?</span><span class="se">\n</span><span class="s">&#39;</span>
            <span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="n">RWHOIS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">&#39;fields&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s">&#39;cidr&#39;</span><span class="p">:</span> <span class="s">r&#39;(network:IP-Network):(?P&lt;val&gt;.+?)\n&#39;</span><span class="p">,</span>
        <span class="s">&#39;name&#39;</span><span class="p">:</span> <span class="s">r&#39;(network:ID):(?P&lt;val&gt;.+?)\n&#39;</span><span class="p">,</span>
        <span class="s">&#39;description&#39;</span><span class="p">:</span> <span class="p">(</span>
            <span class="s">r&#39;(network:(Org-Name|Organization(;I)?)):(?P&lt;val&gt;.+?)\n&#39;</span>
        <span class="p">),</span>
        <span class="s">&#39;country&#39;</span><span class="p">:</span> <span class="s">r&#39;(network:(Country|Country-Code)):(?P&lt;val&gt;.+?)\n&#39;</span><span class="p">,</span>
        <span class="s">&#39;state&#39;</span><span class="p">:</span> <span class="s">r&#39;(network:State):(?P&lt;val&gt;.+?)\n&#39;</span><span class="p">,</span>
        <span class="s">&#39;city&#39;</span><span class="p">:</span> <span class="s">r&#39;(network:City):(?P&lt;val&gt;.+?)\n&#39;</span><span class="p">,</span>
        <span class="s">&#39;address&#39;</span><span class="p">:</span> <span class="s">r&#39;(network:Street-Address):(?P&lt;val&gt;.+?)\n&#39;</span><span class="p">,</span>
        <span class="s">&#39;postal_code&#39;</span><span class="p">:</span> <span class="s">r&#39;(network:Postal-Code):(?P&lt;val&gt;.+?)\n&#39;</span><span class="p">,</span>
        <span class="s">&#39;abuse_emails&#39;</span><span class="p">:</span> <span class="p">(</span>
            <span class="s">r&#39;(network:Abuse-Contact(;I)?):[^\S\n]+(?P&lt;val&gt;[\w\-\.]+?@&#39;</span>
            <span class="s">&#39;[\w\-\.]+\.[\w\-]+)([^\S</span><span class="se">\n</span><span class="s">]+.*?)*?</span><span class="se">\n</span><span class="s">&#39;</span>
        <span class="p">),</span>
        <span class="s">&#39;tech_emails&#39;</span><span class="p">:</span> <span class="p">(</span>
            <span class="s">r&#39;(network:Tech-Contact(;I)?):[^\S\n]+(?P&lt;val&gt;[\w\-\.]+?@&#39;</span>
            <span class="s">&#39;[\w\-\.]+\.[\w\-]+)([^\S</span><span class="se">\n</span><span class="s">]+.*?)*?</span><span class="se">\n</span><span class="s">&#39;</span>
        <span class="p">),</span>
        <span class="s">&#39;misc_emails&#39;</span><span class="p">:</span> <span class="p">(</span>
            <span class="s">r&#39;.+?:.*?[^\S\n]+(?P&lt;val&gt;[\w\-\.]+?@[\w\-\.]+\.[\w\-]+)&#39;</span>
            <span class="s">&#39;([^\S</span><span class="se">\n</span><span class="s">]+.*?)*?</span><span class="se">\n</span><span class="s">&#39;</span>
        <span class="p">),</span>
        <span class="s">&#39;created&#39;</span><span class="p">:</span> <span class="s">r&#39;(network:Created):(?P&lt;val&gt;.+?)\n&#39;</span><span class="p">,</span>
        <span class="s">&#39;updated&#39;</span><span class="p">:</span> <span class="s">r&#39;(network:Updated):(?P&lt;val&gt;.+?)\n&#39;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="n">BLACKLIST</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s">&#39;root.rwhois.net&#39;</span>
<span class="p">]</span>

<span class="n">ASN_REFERRALS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">&#39;whois://whois.ripe.net&#39;</span><span class="p">:</span> <span class="s">&#39;ripencc&#39;</span><span class="p">,</span>
    <span class="s">&#39;whois://whois.apnic.net&#39;</span><span class="p">:</span> <span class="s">&#39;apnic&#39;</span><span class="p">,</span>
    <span class="s">&#39;whois://whois.lacnic.net&#39;</span><span class="p">:</span> <span class="s">&#39;lacnic&#39;</span><span class="p">,</span>
    <span class="s">&#39;whois://whois.afrinic.net&#39;</span><span class="p">:</span> <span class="s">&#39;afrinic&#39;</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">CYMRU_WHOIS</span> <span class="o">=</span> <span class="s">&#39;whois.cymru.com&#39;</span>

<span class="n">IPV4_DNS_ZONE</span> <span class="o">=</span> <span class="s">&#39;{0}.origin.asn.cymru.com&#39;</span>

<span class="n">IPV6_DNS_ZONE</span> <span class="o">=</span> <span class="s">&#39;{0}.origin6.asn.cymru.com&#39;</span>

<span class="n">BASE_NET</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">&#39;cidr&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
    <span class="s">&#39;name&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
    <span class="s">&#39;handle&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
    <span class="s">&#39;range&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
    <span class="s">&#39;description&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
    <span class="s">&#39;country&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
    <span class="s">&#39;state&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
    <span class="s">&#39;city&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
    <span class="s">&#39;address&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
    <span class="s">&#39;postal_code&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
    <span class="s">&#39;abuse_emails&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
    <span class="s">&#39;tech_emails&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
    <span class="s">&#39;misc_emails&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
    <span class="s">&#39;created&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
    <span class="s">&#39;updated&#39;</span><span class="p">:</span> <span class="bp">None</span>
<span class="p">}</span>


<div class="viewcode-block" id="IPDefinedError"><a class="viewcode-back" href="../../ipwhois.html#ipwhois.ipwhois.IPDefinedError">[docs]</a><span class="k">class</span> <span class="nc">IPDefinedError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    An Exception for when the IP is defined (does not need to be resolved).</span>
<span class="sd">    &quot;&quot;&quot;</span>

</div>
<div class="viewcode-block" id="ASNLookupError"><a class="viewcode-back" href="../../ipwhois.html#ipwhois.ipwhois.ASNLookupError">[docs]</a><span class="k">class</span> <span class="nc">ASNLookupError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    An Exception for when the ASN lookup failed.</span>
<span class="sd">    &quot;&quot;&quot;</span>

</div>
<div class="viewcode-block" id="ASNRegistryError"><a class="viewcode-back" href="../../ipwhois.html#ipwhois.ipwhois.ASNRegistryError">[docs]</a><span class="k">class</span> <span class="nc">ASNRegistryError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    An Exception for when the ASN registry does not match one of the five</span>
<span class="sd">    expected values (arin, ripencc, apnic, lacnic, afrinic).</span>
<span class="sd">    &quot;&quot;&quot;</span>

</div>
<div class="viewcode-block" id="WhoisLookupError"><a class="viewcode-back" href="../../ipwhois.html#ipwhois.ipwhois.WhoisLookupError">[docs]</a><span class="k">class</span> <span class="nc">WhoisLookupError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    An Exception for when the Whois lookup failed.</span>
<span class="sd">    &quot;&quot;&quot;</span>

</div>
<div class="viewcode-block" id="HostLookupError"><a class="viewcode-back" href="../../ipwhois.html#ipwhois.ipwhois.HostLookupError">[docs]</a><span class="k">class</span> <span class="nc">HostLookupError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    An Exception for when the Host lookup failed.</span>
<span class="sd">    &quot;&quot;&quot;</span>

</div>
<div class="viewcode-block" id="BlacklistError"><a class="viewcode-back" href="../../ipwhois.html#ipwhois.ipwhois.BlacklistError">[docs]</a><span class="k">class</span> <span class="nc">BlacklistError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    An Exception for when the server is in a blacklist.</span>
<span class="sd">    &quot;&quot;&quot;</span>

</div>
<div class="viewcode-block" id="IPWhois"><a class="viewcode-back" href="../../ipwhois.html#ipwhois.ipwhois.IPWhois">[docs]</a><span class="k">class</span> <span class="nc">IPWhois</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The class for performing ASN/whois lookups and parsing for IPv4 and IPv6</span>
<span class="sd">    addresses.</span>

<span class="sd">    Args:</span>
<span class="sd">        address: An IPv4 or IPv6 address as a string, integer, IPv4Address, or</span>
<span class="sd">            IPv6Address.</span>
<span class="sd">        timeout: The default timeout for socket connections in seconds.</span>
<span class="sd">        proxy_opener: The urllib.request.OpenerDirector request for proxy</span>
<span class="sd">            support or None.</span>

<span class="sd">    Raises:</span>
<span class="sd">        IPDefinedError: The address provided is defined (does not need to be</span>
<span class="sd">            resolved).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">proxy_opener</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="c">#IPv4Address or IPv6Address</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">IPv4Address</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span>
                <span class="n">address</span><span class="p">,</span> <span class="n">IPv6Address</span><span class="p">):</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">address</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="c">#Use ipaddress package exception handling.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">ip_address</span><span class="p">(</span><span class="n">address</span><span class="p">)</span>

        <span class="c">#Default timeout for socket connections.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">timeout</span>

        <span class="c">#Proxy opener.</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">proxy_opener</span><span class="p">,</span> <span class="n">OpenerDirector</span><span class="p">):</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">opener</span> <span class="o">=</span> <span class="n">proxy_opener</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="n">handler</span> <span class="o">=</span> <span class="n">ProxyHandler</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">opener</span> <span class="o">=</span> <span class="n">build_opener</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>

        <span class="c">#IP address in string format for use in queries.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">address_str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">address</span><span class="o">.</span><span class="n">__str__</span><span class="p">()</span>

        <span class="c">#Determine the IP version, 4 or 6</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">address</span><span class="o">.</span><span class="n">version</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>

            <span class="c">#Check if no ASN/whois resolution needs to occur.</span>
            <span class="n">is_defined</span> <span class="o">=</span> <span class="n">ipv4_is_defined</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">address_str</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">is_defined</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>

                <span class="k">raise</span> <span class="n">IPDefinedError</span><span class="p">(</span>
                    <span class="s">&#39;IPv4 address </span><span class="si">%r</span><span class="s"> is already defined as </span><span class="si">%r</span><span class="s"> via &#39;</span>
                    <span class="s">&#39;</span><span class="si">%r</span><span class="s">.&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">address_str</span><span class="p">,</span> <span class="n">is_defined</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">is_defined</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                    <span class="p">)</span>
                <span class="p">)</span>

            <span class="c">#Reverse the IPv4Address for the DNS ASN query.</span>
            <span class="n">split</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">address_str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)</span>
            <span class="n">split</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reversed</span> <span class="o">=</span> <span class="s">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">split</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">dns_zone</span> <span class="o">=</span> <span class="n">IPV4_DNS_ZONE</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reversed</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="c">#Check if no ASN/whois resolution needs to occur.</span>
            <span class="n">is_defined</span> <span class="o">=</span> <span class="n">ipv6_is_defined</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">address_str</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">is_defined</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>

                <span class="k">raise</span> <span class="n">IPDefinedError</span><span class="p">(</span>
                    <span class="s">&#39;IPv6 address </span><span class="si">%r</span><span class="s"> is already defined as </span><span class="si">%r</span><span class="s"> via &#39;</span>
                    <span class="s">&#39;</span><span class="si">%r</span><span class="s">.&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">address_str</span><span class="p">,</span> <span class="n">is_defined</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">is_defined</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                    <span class="p">)</span>
                <span class="p">)</span>

            <span class="c">#Explode the IPv6Address to fill in any missing 0&#39;s.</span>
            <span class="n">exploded</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">address</span><span class="o">.</span><span class="n">exploded</span>

            <span class="c">#Cymru seems to timeout when the IPv6 address has trailing &#39;0000&#39;</span>
            <span class="c">#groups. Remove these groups.</span>
            <span class="n">groups</span> <span class="o">=</span> <span class="n">exploded</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;:&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">enumerate</span><span class="p">(</span><span class="n">groups</span><span class="p">))):</span>

                <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="s">&#39;0000&#39;</span><span class="p">:</span>

                    <span class="k">del</span> <span class="n">groups</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>

                <span class="k">else</span><span class="p">:</span>

                    <span class="k">break</span>

            <span class="n">exploded</span> <span class="o">=</span> <span class="s">&#39;:&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">groups</span><span class="p">)</span>

            <span class="c">#Reverse the IPv6Address for the DNS ASN query.</span>
            <span class="n">val</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">exploded</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;:&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">val</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reversed</span> <span class="o">=</span> <span class="s">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">dns_zone</span> <span class="o">=</span> <span class="n">IPV6_DNS_ZONE</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reversed</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">return</span> <span class="s">&#39;IPWhois(</span><span class="si">%r</span><span class="s">, </span><span class="si">%r</span><span class="s">, </span><span class="si">%r</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">address_str</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">opener</span>
        <span class="p">)</span>

<div class="viewcode-block" id="IPWhois.get_asn_dns"><a class="viewcode-back" href="../../ipwhois.html#ipwhois.ipwhois.IPWhois.get_asn_dns">[docs]</a>    <span class="k">def</span> <span class="nf">get_asn_dns</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The function for retrieving ASN information for an IP address from</span>
<span class="sd">        Cymru via port 53 (DNS).</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dictionary: A dictionary containing the following keys:</span>
<span class="sd">                    asn (String) - The Autonomous System Number.</span>
<span class="sd">                    asn_date (String) - The ASN Allocation date.</span>
<span class="sd">                    asn_registry (String) - The assigned ASN registry.</span>
<span class="sd">                    asn_cidr (String) - The assigned ASN CIDR.</span>
<span class="sd">                    asn_country_code (String) - The assigned ASN country code.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ASNRegistryError: The ASN registry is not known.</span>
<span class="sd">            ASNLookupError: The ASN lookup failed.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>

            <span class="n">data</span> <span class="o">=</span> <span class="n">dns</span><span class="o">.</span><span class="n">resolver</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dns_zone</span><span class="p">,</span> <span class="s">&#39;TXT&#39;</span><span class="p">)</span>

            <span class="c">#Parse out the ASN information.</span>
            <span class="n">temp</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;|&#39;</span><span class="p">)</span>

            <span class="n">ret</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;asn_registry&#39;</span><span class="p">:</span> <span class="n">temp</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s">&#39; </span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)}</span>

            <span class="k">if</span> <span class="n">ret</span><span class="p">[</span><span class="s">&#39;asn_registry&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">NIC_WHOIS</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>

                <span class="k">raise</span> <span class="n">ASNRegistryError</span><span class="p">(</span>
                    <span class="s">&#39;ASN registry </span><span class="si">%r</span><span class="s"> is not known.&#39;</span> <span class="o">%</span> <span class="n">ret</span><span class="p">[</span><span class="s">&#39;asn_registry&#39;</span><span class="p">]</span>
                <span class="p">)</span>

            <span class="n">ret</span><span class="p">[</span><span class="s">&#39;asn&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s">&#39; &quot;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
            <span class="n">ret</span><span class="p">[</span><span class="s">&#39;asn_cidr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s">&#39; </span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
            <span class="n">ret</span><span class="p">[</span><span class="s">&#39;asn_country_code&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s">&#39; </span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
            <span class="n">ret</span><span class="p">[</span><span class="s">&#39;asn_date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s">&#39; &quot;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">ret</span>

        <span class="k">except</span> <span class="n">ASNRegistryError</span><span class="p">:</span>

            <span class="k">raise</span>
        
        <span class="k">except</span><span class="p">:</span>

            <span class="k">raise</span> <span class="n">ASNLookupError</span><span class="p">(</span>
                <span class="s">&#39;ASN lookup failed for </span><span class="si">%r</span><span class="s">.&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">address_str</span>
            <span class="p">)</span>
</div>
<div class="viewcode-block" id="IPWhois.get_asn_whois"><a class="viewcode-back" href="../../ipwhois.html#ipwhois.ipwhois.IPWhois.get_asn_whois">[docs]</a>    <span class="k">def</span> <span class="nf">get_asn_whois</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">retry_count</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The function for retrieving ASN information for an IP address from</span>
<span class="sd">        Cymru via port 43 (WHOIS).</span>

<span class="sd">        Args:</span>
<span class="sd">            retry_count: The number of times to retry in case socket errors,</span>
<span class="sd">                timeouts, connection resets, etc. are encountered.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dictionary: A dictionary containing the following keys:</span>
<span class="sd">                    asn (String) - The Autonomous System Number.</span>
<span class="sd">                    asn_date (String) - The ASN Allocation date.</span>
<span class="sd">                    asn_registry (String) - The assigned ASN registry.</span>
<span class="sd">                    asn_cidr (String) - The assigned ASN CIDR.</span>
<span class="sd">                    asn_country_code (String) - The assigned ASN country code.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ASNRegistryError: The ASN registry is not known.</span>
<span class="sd">            ASNLookupError: The ASN lookup failed.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>

            <span class="c">#Create the connection for the Cymru whois query.</span>
            <span class="n">conn</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">settimeout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">)</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="n">CYMRU_WHOIS</span><span class="p">,</span> <span class="mi">43</span><span class="p">))</span>

            <span class="c">#Query the Cymru whois server, and store the results.</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">send</span><span class="p">((</span>
                <span class="s">&#39; -r -a -c -p -f -o </span><span class="si">%s%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">address_str</span><span class="p">,</span> <span class="s">&#39;</span><span class="se">\r\n</span><span class="s">&#39;</span><span class="p">)</span>
            <span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>

            <span class="n">data</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
            <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>

                <span class="n">d</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">4096</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
                <span class="n">data</span> <span class="o">+=</span> <span class="n">d</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">d</span><span class="p">:</span>

                    <span class="k">break</span>

            <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

            <span class="c">#Parse out the ASN information.</span>
            <span class="n">temp</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;|&#39;</span><span class="p">)</span>

            <span class="n">ret</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;asn_registry&#39;</span><span class="p">:</span> <span class="n">temp</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s">&#39; </span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)}</span>

            <span class="k">if</span> <span class="n">ret</span><span class="p">[</span><span class="s">&#39;asn_registry&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">NIC_WHOIS</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>

                <span class="k">raise</span> <span class="n">ASNRegistryError</span><span class="p">(</span>
                    <span class="s">&#39;ASN registry </span><span class="si">%r</span><span class="s"> is not known.&#39;</span> <span class="o">%</span> <span class="n">ret</span><span class="p">[</span><span class="s">&#39;asn_registry&#39;</span><span class="p">]</span>
                <span class="p">)</span>

            <span class="n">ret</span><span class="p">[</span><span class="s">&#39;asn&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s">&#39; </span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
            <span class="n">ret</span><span class="p">[</span><span class="s">&#39;asn_cidr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s">&#39; </span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
            <span class="n">ret</span><span class="p">[</span><span class="s">&#39;asn_country_code&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s">&#39; </span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
            <span class="n">ret</span><span class="p">[</span><span class="s">&#39;asn_date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s">&#39; </span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">ret</span>

        <span class="k">except</span> <span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">timeout</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">error</span><span class="p">):</span>

            <span class="k">if</span> <span class="n">retry_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>

                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_asn_whois</span><span class="p">(</span><span class="n">retry_count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>

                <span class="k">raise</span> <span class="n">ASNLookupError</span><span class="p">(</span>
                    <span class="s">&#39;ASN lookup failed for </span><span class="si">%r</span><span class="s">.&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">address_str</span>
                <span class="p">)</span>

        <span class="k">except</span> <span class="n">ASNRegistryError</span><span class="p">:</span>

            <span class="k">raise</span>

        <span class="k">except</span><span class="p">:</span>

            <span class="k">raise</span> <span class="n">ASNLookupError</span><span class="p">(</span>
                <span class="s">&#39;ASN lookup failed for </span><span class="si">%r</span><span class="s">.&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">address_str</span>
            <span class="p">)</span>
</div>
<div class="viewcode-block" id="IPWhois.get_whois"><a class="viewcode-back" href="../../ipwhois.html#ipwhois.ipwhois.IPWhois.get_whois">[docs]</a>    <span class="k">def</span> <span class="nf">get_whois</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">asn_registry</span><span class="o">=</span><span class="s">&#39;arin&#39;</span><span class="p">,</span> <span class="n">retry_count</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">server</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                  <span class="n">port</span><span class="o">=</span><span class="mi">43</span><span class="p">,</span> <span class="n">extra_blacklist</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The function for retrieving whois or rwhois information for an IP</span>
<span class="sd">        address via any port. Defaults to port 43 (WHOIS).</span>

<span class="sd">        Args:</span>
<span class="sd">            asn_registry: The NIC to run the query against.</span>
<span class="sd">            retry_count: The number of times to retry in case socket errors,</span>
<span class="sd">                timeouts, connection resets, etc. are encountered.</span>
<span class="sd">            server: An optional server to connect to. If provided, asn_registry</span>
<span class="sd">                will be ignored.</span>
<span class="sd">            port: The network port to connect on.</span>
<span class="sd">            extra_blacklist: A list of blacklisted whois servers in addition to</span>
<span class="sd">                the global BLACKLIST.</span>

<span class="sd">        Returns:</span>
<span class="sd">            String: The raw whois data.</span>

<span class="sd">        Raises:</span>
<span class="sd">            BlacklistError: Raised if the whois server provided is in the</span>
<span class="sd">                global BLACKLIST or extra_blacklist.</span>
<span class="sd">            WhoisLookupError: The whois lookup failed.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>

            <span class="n">extra_bl</span> <span class="o">=</span> <span class="n">extra_blacklist</span> <span class="k">if</span> <span class="n">extra_blacklist</span> <span class="k">else</span> <span class="p">[]</span>

            <span class="k">if</span> <span class="n">server</span> <span class="ow">in</span> <span class="p">(</span><span class="n">BLACKLIST</span><span class="p">,</span> <span class="n">extra_bl</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">BlacklistError</span><span class="p">(</span>
                    <span class="s">&#39;The server </span><span class="si">%r</span><span class="s"> is blacklisted.&#39;</span> <span class="o">%</span> <span class="n">server</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="n">server</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">server</span> <span class="o">=</span> <span class="n">NIC_WHOIS</span><span class="p">[</span><span class="n">asn_registry</span><span class="p">][</span><span class="s">&#39;server&#39;</span><span class="p">]</span>

            <span class="c">#Create the connection for the whois query.</span>
            <span class="n">conn</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">settimeout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">)</span>

            <span class="n">conn</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="n">server</span><span class="p">,</span> <span class="n">port</span><span class="p">))</span>

            <span class="c">#Prep the query.</span>
            <span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">address_str</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\r\n</span><span class="s">&#39;</span>
            <span class="k">if</span> <span class="n">asn_registry</span> <span class="o">==</span> <span class="s">&#39;arin&#39;</span><span class="p">:</span>

                <span class="n">query</span> <span class="o">=</span> <span class="s">&#39;n + </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">query</span>

            <span class="c">#Query the whois server, and store the results.</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>

            <span class="n">response</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
            <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>

                <span class="n">d</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">4096</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&#39;ascii&#39;</span><span class="p">,</span> <span class="s">&#39;ignore&#39;</span><span class="p">)</span>

                <span class="n">response</span> <span class="o">+=</span> <span class="n">d</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">d</span><span class="p">:</span>

                    <span class="k">break</span>

            <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

            <span class="k">if</span> <span class="s">&#39;Query rate limit exceeded&#39;</span> <span class="ow">in</span> <span class="n">response</span><span class="p">:</span>

                <span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_whois</span><span class="p">(</span><span class="n">asn_registry</span><span class="p">,</span> <span class="n">retry_count</span><span class="p">,</span> <span class="n">server</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span>
                                      <span class="n">extra_blacklist</span><span class="p">)</span>

            <span class="k">elif</span> <span class="s">&#39;error 501&#39;</span> <span class="ow">in</span> <span class="n">response</span> <span class="ow">or</span> <span class="s">&#39;error 230&#39;</span> <span class="ow">in</span> <span class="n">response</span><span class="p">:</span>

                <span class="k">raise</span> <span class="ne">ValueError</span>

            <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>

        <span class="k">except</span> <span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">timeout</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">error</span><span class="p">):</span>

            <span class="k">if</span> <span class="n">retry_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>

                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_whois</span><span class="p">(</span><span class="n">asn_registry</span><span class="p">,</span> <span class="n">retry_count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">server</span><span class="p">,</span>
                                      <span class="n">port</span><span class="p">,</span> <span class="n">extra_blacklist</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>

                <span class="k">raise</span> <span class="n">WhoisLookupError</span><span class="p">(</span>
                    <span class="s">&#39;Whois lookup failed for </span><span class="si">%r</span><span class="s">.&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">address_str</span>
                <span class="p">)</span>

        <span class="k">except</span><span class="p">:</span>

            <span class="k">raise</span> <span class="n">WhoisLookupError</span><span class="p">(</span>
                <span class="s">&#39;Whois lookup failed for </span><span class="si">%r</span><span class="s">.&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">address_str</span>
            <span class="p">)</span>
</div>
<div class="viewcode-block" id="IPWhois.get_rws"><a class="viewcode-back" href="../../ipwhois.html#ipwhois.ipwhois.IPWhois.get_rws">[docs]</a>    <span class="k">def</span> <span class="nf">get_rws</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">retry_count</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The function for retrieving Whois-RWS information for an IP address</span>
<span class="sd">        via HTTP (Whois-RWS).</span>

<span class="sd">        Args:</span>
<span class="sd">            url: The URL to retrieve.</span>
<span class="sd">            retry_count: The number of times to retry in case socket errors,</span>
<span class="sd">                timeouts, connection resets, etc. are encountered.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dictionary: The whois data in Json format.</span>

<span class="sd">        Raises:</span>
<span class="sd">            WhoisLookupError: The whois RWS lookup failed.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>

            <span class="c">#Create the connection for the whois query.</span>
            <span class="n">conn</span> <span class="o">=</span> <span class="n">Request</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;Accept&#39;</span><span class="p">:</span> <span class="s">&#39;application/json&#39;</span><span class="p">})</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">opener</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">d</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">readall</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="n">d</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&#39;ascii&#39;</span><span class="p">,</span> <span class="s">&#39;ignore&#39;</span><span class="p">))</span>

            <span class="k">return</span> <span class="n">d</span>

        <span class="k">except</span> <span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">timeout</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">error</span><span class="p">):</span>

            <span class="k">if</span> <span class="n">retry_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>

                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_rws</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">retry_count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>

                <span class="k">raise</span> <span class="n">WhoisLookupError</span><span class="p">(</span><span class="s">&#39;Whois RWS lookup failed for </span><span class="si">%r</span><span class="s">.&#39;</span> <span class="o">%</span>
                                       <span class="n">url</span><span class="p">)</span>

        <span class="k">except</span><span class="p">:</span>

            <span class="k">raise</span> <span class="n">WhoisLookupError</span><span class="p">(</span><span class="s">&#39;Whois RWS lookup failed for </span><span class="si">%r</span><span class="s">.&#39;</span> <span class="o">%</span> <span class="n">url</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="IPWhois.get_host"><a class="viewcode-back" href="../../ipwhois.html#ipwhois.ipwhois.IPWhois.get_host">[docs]</a>    <span class="k">def</span> <span class="nf">get_host</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">retry_count</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The function for retrieving host information for an IP address.</span>

<span class="sd">        Args:</span>
<span class="sd">            retry_count: The number of times to retry in case socket errors,</span>
<span class="sd">                timeouts, connection resets, etc. are encountered.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Tuple: hostname, aliaslist, ipaddrlist</span>

<span class="sd">        Raises:</span>
<span class="sd">            HostLookupError: The host lookup failed.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>

            <span class="n">default_timeout_set</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">socket</span><span class="o">.</span><span class="n">getdefaulttimeout</span><span class="p">():</span>

                <span class="n">socket</span><span class="o">.</span><span class="n">setdefaulttimeout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">)</span>
                <span class="n">default_timeout_set</span> <span class="o">=</span> <span class="bp">True</span>

            <span class="n">ret</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">gethostbyaddr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">address_str</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">default_timeout_set</span><span class="p">:</span>

                <span class="n">socket</span><span class="o">.</span><span class="n">setdefaulttimeout</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">ret</span>

        <span class="k">except</span> <span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">timeout</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">error</span><span class="p">):</span>

            <span class="k">if</span> <span class="n">retry_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>

                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_host</span><span class="p">(</span><span class="n">retry_count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>

                <span class="k">raise</span> <span class="n">HostLookupError</span><span class="p">(</span>
                    <span class="s">&#39;Host lookup failed for </span><span class="si">%r</span><span class="s">.&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">address_str</span>
                <span class="p">)</span>

        <span class="k">except</span><span class="p">:</span>

            <span class="k">raise</span> <span class="n">HostLookupError</span><span class="p">(</span>
                <span class="s">&#39;Host lookup failed for </span><span class="si">%r</span><span class="s">.&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">address_str</span>
            <span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_parse_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">fields_dict</span><span class="p">,</span> <span class="n">net_start</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                      <span class="n">net_end</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">dt_format</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The function for parsing whois fields from a data input.</span>

<span class="sd">        Args:</span>
<span class="sd">            response: The response from the whois/rwhois server.</span>
<span class="sd">            fields_dict: The dictionary of fields -&gt; regex search values.</span>
<span class="sd">            net_start: The starting point of the network (if parsing multiple</span>
<span class="sd">                networks).</span>
<span class="sd">            net_end: The ending point of the network (if parsing multiple</span>
<span class="sd">                networks).</span>
<span class="sd">            dt_format: The format of datetime fields if known.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dictionary: A dictionary of fields provided in fields_dict.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">ret</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields_dict</span><span class="p">:</span>

            <span class="n">pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">fields_dict</span><span class="p">[</span><span class="n">field</span><span class="p">]),</span>
                <span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">net_start</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>

                <span class="n">match</span> <span class="o">=</span> <span class="n">pattern</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">net_end</span><span class="p">,</span> <span class="n">net_start</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">net_end</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>

                <span class="n">match</span> <span class="o">=</span> <span class="n">pattern</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">net_end</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>

                <span class="n">match</span> <span class="o">=</span> <span class="n">pattern</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>

            <span class="n">values</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">sub_section_end</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">match</span><span class="p">:</span>

                <span class="k">if</span> <span class="n">sub_section_end</span><span class="p">:</span>

                    <span class="k">if</span> <span class="n">field</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span>
                        <span class="s">&#39;abuse_emails&#39;</span><span class="p">,</span>
                        <span class="s">&#39;tech_emails&#39;</span><span class="p">,</span>
                        <span class="s">&#39;misc_emails&#39;</span>
                    <span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">sub_section_end</span> <span class="o">!=</span> <span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">start</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)):</span>

                        <span class="k">break</span>

                <span class="k">try</span><span class="p">:</span>

                    <span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s">&#39;val&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>

                <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>

                    <span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s">&#39;val2&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>

                <span class="n">sub_section_end</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">end</span><span class="p">()</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>

                <span class="n">value</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="k">try</span><span class="p">:</span>

                    <span class="k">if</span> <span class="n">field</span> <span class="o">==</span> <span class="s">&#39;country&#39;</span><span class="p">:</span>

                        <span class="n">value</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>

                    <span class="k">elif</span> <span class="n">field</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;created&#39;</span><span class="p">,</span> <span class="s">&#39;updated&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">dt_format</span><span class="p">:</span>

                        <span class="n">value</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span>
                            <span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">dt_format</span><span class="p">))</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(</span><span class="s">&#39;T&#39;</span><span class="p">)</span>

                    <span class="k">else</span><span class="p">:</span>

                        <span class="n">values</span> <span class="o">=</span> <span class="n">unique_everseen</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>

                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>

                    <span class="k">pass</span>

                <span class="n">ret</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

        <span class="k">return</span> <span class="n">ret</span>

<div class="viewcode-block" id="IPWhois.lookup"><a class="viewcode-back" href="../../ipwhois.html#ipwhois.ipwhois.IPWhois.lookup">[docs]</a>    <span class="k">def</span> <span class="nf">lookup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inc_raw</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">retry_count</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">get_referral</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
               <span class="n">extra_blacklist</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">ignore_referral_errors</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The function for retrieving and parsing whois information for an IP</span>
<span class="sd">        address via port 43 (WHOIS).</span>

<span class="sd">        Args:</span>
<span class="sd">            inc_raw: Boolean for whether to include the raw whois results in</span>
<span class="sd">                the returned dictionary.</span>
<span class="sd">            retry_count: The number of times to retry in case socket errors,</span>
<span class="sd">                timeouts, connection resets, etc. are encountered.</span>
<span class="sd">            get_referral: Boolean for whether to retrieve referral whois</span>
<span class="sd">                information, if available.</span>
<span class="sd">            extra_blacklist: A list of blacklisted whois servers in addition to</span>
<span class="sd">                the global BLACKLIST.</span>
<span class="sd">            ignore_referral_errors: Boolean for whether to ignore and continue</span>
<span class="sd">                when an exception is encountered on referral whois lookups.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dictionary:</span>

<span class="sd">            :query: The IP address (String)</span>
<span class="sd">            :asn: The Autonomous System Number (String)</span>
<span class="sd">            :asn_date: The ASN Allocation date (String)</span>
<span class="sd">            :asn_registry: The assigned ASN registry (String)</span>
<span class="sd">            :asn_cidr: The assigned ASN CIDR (String)</span>
<span class="sd">            :asn_country_code: The assigned ASN country code (String)</span>
<span class="sd">            :nets: Dictionaries containing network information which consists</span>
<span class="sd">                of the fields listed in the NIC_WHOIS dictionary. (List)</span>
<span class="sd">            :raw: Raw whois results if the inc_raw parameter is True. (String)</span>
<span class="sd">            :referral: Dictionary of referral whois information if get_referral</span>
<span class="sd">                is True and the server isn&#39;t blacklisted. Consists of fields</span>
<span class="sd">                listed in the RWHOIS dictionary. Additional referral server</span>
<span class="sd">                informaion is added in the server and port keys. (Dictionary)</span>
<span class="sd">            :raw_referral: Raw referral whois results if the inc_raw parameter</span>
<span class="sd">                is True. (String)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c">#Initialize the whois response.</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="c">#Attempt to resolve ASN info via Cymru. DNS is faster, try that first.</span>
        <span class="k">try</span><span class="p">:</span>

            <span class="n">asn_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_asn_dns</span><span class="p">()</span>

        <span class="k">except</span> <span class="p">(</span><span class="n">ASNLookupError</span><span class="p">,</span> <span class="n">ASNRegistryError</span><span class="p">):</span>

            <span class="k">try</span><span class="p">:</span>

                <span class="n">asn_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_asn_whois</span><span class="p">(</span><span class="n">retry_count</span><span class="p">)</span>

            <span class="k">except</span> <span class="p">(</span><span class="n">ASNLookupError</span><span class="p">,</span> <span class="n">ASNRegistryError</span><span class="p">):</span>

                <span class="c">#Lets attempt to get the ASN registry information from ARIN.</span>
                <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_whois</span><span class="p">(</span><span class="s">&#39;arin&#39;</span><span class="p">,</span> <span class="n">retry_count</span><span class="p">)</span>

                <span class="n">asn_data</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s">&#39;asn_registry&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
                    <span class="s">&#39;asn&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
                    <span class="s">&#39;asn_cidr&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
                    <span class="s">&#39;asn_country_code&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
                    <span class="s">&#39;asn_date&#39;</span><span class="p">:</span> <span class="bp">None</span>
                <span class="p">}</span>

                <span class="n">matched</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="k">for</span> <span class="n">match</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span>
                    <span class="s">r&#39;^ReferralServer:[^\S\n]+(.+)$&#39;</span><span class="p">,</span>
                    <span class="n">response</span><span class="p">,</span>
                    <span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span>
                <span class="p">):</span>

                    <span class="n">matched</span> <span class="o">=</span> <span class="bp">True</span>

                    <span class="k">try</span><span class="p">:</span>

                        <span class="n">referral</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                        <span class="n">referral</span> <span class="o">=</span> <span class="n">referral</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;:43&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span>

                        <span class="n">asn_data</span><span class="p">[</span><span class="s">&#39;asn_registry&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ASN_REFERRALS</span><span class="p">[</span><span class="n">referral</span><span class="p">]</span>

                    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>

                        <span class="k">raise</span> <span class="n">ASNRegistryError</span><span class="p">(</span><span class="s">&#39;ASN registry lookup failed.&#39;</span><span class="p">)</span>

                    <span class="k">break</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">matched</span><span class="p">:</span>

                    <span class="n">asn_data</span><span class="p">[</span><span class="s">&#39;asn_registry&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;arin&#39;</span>

        <span class="c">#Create the return dictionary.</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">&#39;query&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">address_str</span><span class="p">,</span>
            <span class="s">&#39;nets&#39;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s">&#39;raw&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
            <span class="s">&#39;referral&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
            <span class="s">&#39;raw_referral&#39;</span><span class="p">:</span> <span class="bp">None</span>
        <span class="p">}</span>

        <span class="c">#Add the ASN information to the return dictionary.</span>
        <span class="n">results</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">asn_data</span><span class="p">)</span>

        <span class="c">#The referral server and port. Only used if get_referral is True.</span>
        <span class="n">referral_server</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">referral_port</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c">#Only fetch the response if we haven&#39;t already.</span>
        <span class="k">if</span> <span class="n">response</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">results</span><span class="p">[</span><span class="s">&#39;asn_registry&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="s">&#39;arin&#39;</span><span class="p">:</span>

            <span class="c">#Retrieve the whois data.</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_whois</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s">&#39;asn_registry&#39;</span><span class="p">],</span> <span class="n">retry_count</span><span class="p">,</span>
                                      <span class="n">extra_blacklist</span><span class="o">=</span><span class="n">extra_blacklist</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">get_referral</span><span class="p">:</span>

                <span class="c">#Search for a referral server.</span>
                <span class="k">for</span> <span class="n">match</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span>
                    <span class="s">r&#39;^ReferralServer:[^\S\n]+(.+:[0-9]+)$&#39;</span><span class="p">,</span>
                    <span class="n">response</span><span class="p">,</span>
                    <span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span>
                <span class="p">):</span>

                    <span class="k">try</span><span class="p">:</span>

                        <span class="n">temp</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                        <span class="k">if</span> <span class="s">&#39;rwhois://&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">temp</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">ValueError</span>

                        <span class="n">temp</span> <span class="o">=</span> <span class="n">temp</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;rwhois://&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;:&#39;</span><span class="p">)</span>

                        <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">temp</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">65535</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">ValueError</span>

                        <span class="n">referral_server</span> <span class="o">=</span> <span class="n">temp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">referral_port</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">temp</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

                    <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">):</span>

                        <span class="k">continue</span>

                    <span class="k">break</span>

        <span class="c">#Retrieve the referral whois data.</span>
        <span class="k">if</span> <span class="n">get_referral</span> <span class="ow">and</span> <span class="n">referral_server</span><span class="p">:</span>

            <span class="n">response_ref</span> <span class="o">=</span> <span class="bp">None</span>

            <span class="k">if</span> <span class="n">ignore_referral_errors</span><span class="p">:</span>

                <span class="k">try</span><span class="p">:</span>

                    <span class="n">response_ref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_whois</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span>
                                                  <span class="n">retry_count</span><span class="p">,</span>
                                                  <span class="n">referral_server</span><span class="p">,</span>
                                                  <span class="n">referral_port</span><span class="p">,</span>
                                                  <span class="n">extra_blacklist</span><span class="p">)</span>

                <span class="k">except</span> <span class="p">(</span><span class="n">BlacklistError</span><span class="p">,</span> <span class="n">WhoisLookupError</span><span class="p">):</span>

                    <span class="k">pass</span>

            <span class="k">else</span><span class="p">:</span>

                <span class="n">response_ref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_whois</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">retry_count</span><span class="p">,</span>
                                              <span class="n">referral_server</span><span class="p">,</span> <span class="n">referral_port</span><span class="p">,</span>
                                              <span class="n">extra_blacklist</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">response_ref</span><span class="p">:</span>

                <span class="k">if</span> <span class="n">inc_raw</span><span class="p">:</span>

                    <span class="n">results</span><span class="p">[</span><span class="s">&#39;raw_referral&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">response_ref</span>

                <span class="n">temp_rnet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_fields</span><span class="p">(</span>
                    <span class="n">response_ref</span><span class="p">,</span>
                    <span class="n">RWHOIS</span><span class="p">[</span><span class="s">&#39;fields&#39;</span><span class="p">]</span>
                <span class="p">)</span>

                <span class="c">#Add the networks to the return dictionary.</span>
                <span class="n">results</span><span class="p">[</span><span class="s">&#39;referral&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp_rnet</span>

        <span class="c">#If inc_raw parameter is True, add the response to return dictionary.</span>
        <span class="k">if</span> <span class="n">inc_raw</span><span class="p">:</span>

            <span class="n">results</span><span class="p">[</span><span class="s">&#39;raw&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">response</span>

        <span class="n">nets</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="n">results</span><span class="p">[</span><span class="s">&#39;asn_registry&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;arin&#39;</span><span class="p">:</span>

            <span class="c">#Find the first NetRange value.</span>
            <span class="n">pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
                <span class="s">r&#39;^NetRange:[^\S\n]+(.+)$&#39;</span><span class="p">,</span>
                <span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span>
            <span class="p">)</span>
            <span class="n">temp</span> <span class="o">=</span> <span class="n">pattern</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
            <span class="n">net_range</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">net_range_start</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">if</span> <span class="n">temp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">net_range</span> <span class="o">=</span> <span class="n">temp</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="n">net_range_start</span> <span class="o">=</span> <span class="n">temp</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

            <span class="c">#Iterate through all of the networks found, storing the CIDR value</span>
            <span class="c">#and the start and end positions.</span>
            <span class="k">for</span> <span class="n">match</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span>
                <span class="s">r&#39;^CIDR:[^\S\n]+(.+?,[^\S\n].+|.+)$&#39;</span><span class="p">,</span>
                <span class="n">response</span><span class="p">,</span>
                <span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span>
            <span class="p">):</span>

                <span class="k">try</span><span class="p">:</span>

                    <span class="n">net</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">BASE_NET</span><span class="p">)</span>

                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">nets</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">temp</span> <span class="o">=</span> <span class="n">pattern</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">match</span><span class="o">.</span><span class="n">start</span><span class="p">())</span>
                        <span class="n">net_range</span> <span class="o">=</span> <span class="bp">None</span>
                        <span class="n">net_range_start</span> <span class="o">=</span> <span class="bp">None</span>
                        <span class="k">if</span> <span class="n">temp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                            <span class="n">net_range</span> <span class="o">=</span> <span class="n">temp</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                            <span class="n">net_range_start</span> <span class="o">=</span> <span class="n">temp</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

                    <span class="k">if</span> <span class="n">net_range</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">net_range_start</span> <span class="o">&lt;</span> <span class="n">match</span><span class="o">.</span><span class="n">start</span><span class="p">()</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">nets</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">net</span><span class="p">[</span><span class="s">&#39;range&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">net_range</span>

                    <span class="n">net</span><span class="p">[</span><span class="s">&#39;cidr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                        <span class="p">[</span><span class="n">ip_network</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span><span class="o">.</span><span class="n">__str__</span><span class="p">()</span>
                         <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;, &#39;</span><span class="p">)]</span>
                    <span class="p">)</span>
                    <span class="n">net</span><span class="p">[</span><span class="s">&#39;start&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
                    <span class="n">net</span><span class="p">[</span><span class="s">&#39;end&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">end</span><span class="p">()</span>
                    <span class="n">nets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">net</span><span class="p">)</span>

                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>

                    <span class="k">pass</span>

        <span class="k">elif</span> <span class="n">results</span><span class="p">[</span><span class="s">&#39;asn_registry&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;lacnic&#39;</span><span class="p">:</span>

            <span class="c">#Iterate through all of the networks found, storing the CIDR value</span>
            <span class="c">#and the start and end positions.</span>
            <span class="k">for</span> <span class="n">match</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span>
                <span class="s">r&#39;^(inetnum|inet6num|route):[^\S\n]+(.+?,[^\S\n].+|.+)$&#39;</span><span class="p">,</span>
                <span class="n">response</span><span class="p">,</span>
                <span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span>
            <span class="p">):</span>

                <span class="k">try</span><span class="p">:</span>

                    <span class="n">net</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">BASE_NET</span><span class="p">)</span>
                    <span class="n">net</span><span class="p">[</span><span class="s">&#39;range&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

                    <span class="n">temp</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">addr</span> <span class="ow">in</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;, &#39;</span><span class="p">):</span>

                        <span class="n">count</span> <span class="o">=</span> <span class="n">addr</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">count</span> <span class="ow">is</span> <span class="ow">not</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>

                            <span class="n">addr_split</span> <span class="o">=</span> <span class="n">addr</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">):</span>
                                <span class="n">addr_split</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="s">&#39;.0&#39;</span>

                            <span class="n">addr</span> <span class="o">=</span> <span class="s">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">addr_split</span><span class="p">)</span>

                        <span class="n">temp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ip_network</span><span class="p">(</span><span class="n">addr</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span><span class="o">.</span><span class="n">__str__</span><span class="p">())</span>

                    <span class="n">net</span><span class="p">[</span><span class="s">&#39;cidr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span>
                    <span class="n">net</span><span class="p">[</span><span class="s">&#39;start&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
                    <span class="n">net</span><span class="p">[</span><span class="s">&#39;end&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">end</span><span class="p">()</span>
                    <span class="n">nets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">net</span><span class="p">)</span>

                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>

                    <span class="k">pass</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="c">#Iterate through all of the networks found, storing the CIDR value</span>
            <span class="c">#and the start and end positions.</span>
            <span class="k">for</span> <span class="n">match</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span>
                <span class="s">r&#39;^(inetnum|inet6num|route):[^\S\n]+((.+?)[^\S\n]-[^\S\n](.+)|&#39;</span>
                    <span class="s">&#39;.+)$&#39;</span><span class="p">,</span>
                <span class="n">response</span><span class="p">,</span>
                <span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span>
            <span class="p">):</span>

                <span class="k">try</span><span class="p">:</span>

                    <span class="n">net</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">BASE_NET</span><span class="p">)</span>
                    <span class="n">net</span><span class="p">[</span><span class="s">&#39;range&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="ow">and</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>

                        <span class="n">addrs</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="n">addrs</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">summarize_address_range</span><span class="p">(</span>
                            <span class="n">ip_address</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()),</span>
                            <span class="n">ip_address</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">())))</span>

                        <span class="n">cidr</span> <span class="o">=</span> <span class="s">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                            <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">__str__</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">collapse_addresses</span><span class="p">(</span><span class="n">addrs</span><span class="p">)]</span>
                        <span class="p">)</span>

                    <span class="k">else</span><span class="p">:</span>

                        <span class="n">cidr</span> <span class="o">=</span> <span class="n">ip_network</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span><span class="o">.</span><span class="n">__str__</span><span class="p">()</span>

                    <span class="n">net</span><span class="p">[</span><span class="s">&#39;cidr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cidr</span>
                    <span class="n">net</span><span class="p">[</span><span class="s">&#39;start&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
                    <span class="n">net</span><span class="p">[</span><span class="s">&#39;end&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">end</span><span class="p">()</span>
                    <span class="n">nets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">net</span><span class="p">)</span>

                <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>

                    <span class="k">pass</span>

        <span class="c">#Iterate through all of the network sections and parse out the</span>
        <span class="c">#appropriate fields for each.</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">net</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">nets</span><span class="p">):</span>

            <span class="n">section_end</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">if</span> <span class="n">index</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">nets</span><span class="p">):</span>

                <span class="n">section_end</span> <span class="o">=</span> <span class="n">nets</span><span class="p">[</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">][</span><span class="s">&#39;start&#39;</span><span class="p">]</span>

            <span class="k">try</span><span class="p">:</span>

                <span class="n">dt_format</span> <span class="o">=</span> <span class="n">NIC_WHOIS</span><span class="p">[</span><span class="n">results</span><span class="p">[</span><span class="s">&#39;asn_registry&#39;</span><span class="p">]][</span><span class="s">&#39;dt_format&#39;</span><span class="p">]</span>

            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>

                <span class="n">dt_format</span> <span class="o">=</span> <span class="bp">None</span>

            <span class="n">temp_net</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_fields</span><span class="p">(</span>
                <span class="n">response</span><span class="p">,</span>
                <span class="n">NIC_WHOIS</span><span class="p">[</span><span class="n">results</span><span class="p">[</span><span class="s">&#39;asn_registry&#39;</span><span class="p">]][</span><span class="s">&#39;fields&#39;</span><span class="p">],</span>
                <span class="n">section_end</span><span class="p">,</span>
                <span class="n">net</span><span class="p">[</span><span class="s">&#39;end&#39;</span><span class="p">],</span>
                <span class="n">dt_format</span>
            <span class="p">)</span>

            <span class="c">#Merge the net dictionaries.</span>
            <span class="n">net</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">temp_net</span><span class="p">)</span>

            <span class="c">#The start and end values are no longer needed.</span>
            <span class="k">del</span> <span class="n">net</span><span class="p">[</span><span class="s">&#39;start&#39;</span><span class="p">],</span> <span class="n">net</span><span class="p">[</span><span class="s">&#39;end&#39;</span><span class="p">]</span>

        <span class="c">#Add the networks to the return dictionary.</span>
        <span class="n">results</span><span class="p">[</span><span class="s">&#39;nets&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nets</span>

        <span class="k">return</span> <span class="n">results</span>
</div>
    <span class="k">def</span> <span class="nf">_lookup_rws_arin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">retry_count</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The function for retrieving and parsing whois information for an ARIN</span>
<span class="sd">        IP address via HTTP (Whois-RWS).</span>

<span class="sd">        Args:</span>
<span class="sd">            response: The dictionary containing whois information to parse.</span>
<span class="sd">            retry_count: The number of times to retry in case socket errors,</span>
<span class="sd">                timeouts, connection resets, etc. are encountered.</span>

<span class="sd">        Returns:</span>
<span class="sd">            List: Dictionaries containing network information which consists</span>
<span class="sd">                of the fields listed in the NIC_WHOIS dictionary. Certain IPs</span>
<span class="sd">                have more granular network listings, hence the need for a list</span>
<span class="sd">                object.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">nets</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">try</span><span class="p">:</span>

            <span class="n">net_list</span> <span class="o">=</span> <span class="n">response</span><span class="p">[</span><span class="s">&#39;nets&#39;</span><span class="p">][</span><span class="s">&#39;net&#39;</span><span class="p">]</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">net_list</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>

                <span class="n">net_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">net_list</span><span class="p">]</span>

        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>

            <span class="n">net_list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">net_list</span><span class="p">:</span>

            <span class="k">if</span> <span class="s">&#39;orgRef&#39;</span> <span class="ow">in</span> <span class="n">n</span> <span class="ow">and</span> <span class="n">n</span><span class="p">[</span><span class="s">&#39;orgRef&#39;</span><span class="p">][</span><span class="s">&#39;@handle&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;ARIN&#39;</span><span class="p">,</span> <span class="s">&#39;VR-ARIN&#39;</span><span class="p">):</span>

                <span class="k">continue</span>

            <span class="n">addrs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">net</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">BASE_NET</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>

                <span class="n">addrs</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">summarize_address_range</span><span class="p">(</span>
                    <span class="n">ip_address</span><span class="p">(</span><span class="n">n</span><span class="p">[</span><span class="s">&#39;startAddress&#39;</span><span class="p">][</span><span class="s">&#39;$&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()),</span>
                    <span class="n">ip_address</span><span class="p">(</span><span class="n">n</span><span class="p">[</span><span class="s">&#39;endAddress&#39;</span><span class="p">][</span><span class="s">&#39;$&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())))</span>

                <span class="n">net</span><span class="p">[</span><span class="s">&#39;cidr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">__str__</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">collapse_addresses</span><span class="p">(</span><span class="n">addrs</span><span class="p">)]</span>
                <span class="p">)</span>

                <span class="n">net</span><span class="p">[</span><span class="s">&#39;range&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">n</span><span class="p">[</span><span class="s">&#39;startAddress&#39;</span><span class="p">][</span><span class="s">&#39;$&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">+</span> <span class="s">&#39; - &#39;</span> <span class="o">+</span>
                                <span class="n">n</span><span class="p">[</span><span class="s">&#39;endAddress&#39;</span><span class="p">][</span><span class="s">&#39;$&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>

            <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>

                <span class="k">pass</span>

            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="p">{</span>
                <span class="s">&#39;created&#39;</span><span class="p">:</span> <span class="s">&#39;registrationDate&#39;</span><span class="p">,</span>
                <span class="s">&#39;updated&#39;</span><span class="p">:</span> <span class="s">&#39;updateDate&#39;</span><span class="p">,</span>
                <span class="s">&#39;name&#39;</span><span class="p">:</span> <span class="s">&#39;name&#39;</span>
            <span class="p">}</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>

                <span class="k">try</span><span class="p">:</span>

                    <span class="n">net</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="p">[</span><span class="n">v</span><span class="p">][</span><span class="s">&#39;$&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>

                    <span class="k">pass</span>

            <span class="k">if</span> <span class="s">&#39;handle&#39;</span> <span class="ow">in</span> <span class="n">n</span><span class="p">:</span>

                <span class="n">net</span><span class="p">[</span><span class="s">&#39;handle&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">n</span><span class="p">[</span><span class="s">&#39;handle&#39;</span><span class="p">][</span><span class="s">&#39;$&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

            <span class="n">ref</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">if</span> <span class="s">&#39;customerRef&#39;</span> <span class="ow">in</span> <span class="n">n</span><span class="p">:</span>

                <span class="n">ref</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;customerRef&#39;</span><span class="p">,</span> <span class="s">&#39;customer&#39;</span><span class="p">]</span>

            <span class="k">elif</span> <span class="s">&#39;orgRef&#39;</span> <span class="ow">in</span> <span class="n">n</span><span class="p">:</span>

                <span class="n">ref</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;orgRef&#39;</span><span class="p">,</span> <span class="s">&#39;org&#39;</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">ref</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>

                <span class="k">try</span><span class="p">:</span>

                    <span class="n">net</span><span class="p">[</span><span class="s">&#39;description&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="p">[</span><span class="n">ref</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="s">&#39;@name&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>

                    <span class="k">pass</span>

                <span class="k">try</span><span class="p">:</span>

                    <span class="n">ref_url</span> <span class="o">=</span> <span class="n">n</span><span class="p">[</span><span class="n">ref</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="s">&#39;$&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">+</span> <span class="s">&#39;?showPocs=true&#39;</span>
                    <span class="n">ref_response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_rws</span><span class="p">(</span><span class="n">ref_url</span><span class="p">,</span> <span class="n">retry_count</span><span class="p">)</span>

                <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="n">WhoisLookupError</span><span class="p">):</span>

                    <span class="n">nets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">net</span><span class="p">)</span>
                    <span class="k">continue</span>

                <span class="k">try</span><span class="p">:</span>

                    <span class="n">addr_list</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">ref_response</span><span class="p">[</span><span class="n">ref</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="s">&#39;streetAddress&#39;</span><span class="p">][</span><span class="s">&#39;line&#39;</span><span class="p">]</span>
                    <span class="p">)</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">addr_list</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>

                        <span class="n">addr_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">addr_list</span><span class="p">]</span>

                    <span class="n">net</span><span class="p">[</span><span class="s">&#39;address&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                        <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="s">&#39;$&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">addr_list</span><span class="p">]</span>
                    <span class="p">)</span>

                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>

                    <span class="k">pass</span>

                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="p">{</span>
                    <span class="s">&#39;postal_code&#39;</span><span class="p">:</span> <span class="s">&#39;postalCode&#39;</span><span class="p">,</span>
                    <span class="s">&#39;city&#39;</span><span class="p">:</span> <span class="s">&#39;city&#39;</span><span class="p">,</span>
                    <span class="s">&#39;state&#39;</span><span class="p">:</span> <span class="s">&#39;iso3166-2&#39;</span>
                <span class="p">}</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>

                    <span class="k">try</span><span class="p">:</span>

                        <span class="n">net</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">ref_response</span><span class="p">[</span><span class="n">ref</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="n">v</span><span class="p">][</span><span class="s">&#39;$&#39;</span><span class="p">])</span>

                    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>

                        <span class="k">pass</span>

                <span class="k">try</span><span class="p">:</span>

                    <span class="n">net</span><span class="p">[</span><span class="s">&#39;country&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">ref_response</span><span class="p">[</span><span class="n">ref</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="s">&#39;iso3166-1&#39;</span><span class="p">][</span><span class="s">&#39;code2&#39;</span><span class="p">][</span><span class="s">&#39;$&#39;</span><span class="p">])</span>
                    <span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>

                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>

                    <span class="k">pass</span>

                <span class="k">try</span><span class="p">:</span>

                    <span class="k">for</span> <span class="n">poc</span> <span class="ow">in</span> <span class="p">(</span>
                        <span class="n">ref_response</span><span class="p">[</span><span class="n">ref</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="s">&#39;pocs&#39;</span><span class="p">][</span><span class="s">&#39;pocLinkRef&#39;</span><span class="p">]</span>
                    <span class="p">):</span>

                        <span class="k">if</span> <span class="n">poc</span><span class="p">[</span><span class="s">&#39;@description&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;Abuse&#39;</span><span class="p">,</span> <span class="s">&#39;Tech&#39;</span><span class="p">):</span>

                            <span class="n">poc_url</span> <span class="o">=</span> <span class="n">poc</span><span class="p">[</span><span class="s">&#39;$&#39;</span><span class="p">]</span>
                            <span class="n">poc_response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_rws</span><span class="p">(</span>
                                <span class="n">poc_url</span><span class="p">,</span>
                                <span class="n">retry_count</span>
                            <span class="p">)</span>

                            <span class="n">emails</span> <span class="o">=</span> <span class="n">poc_response</span><span class="p">[</span><span class="s">&#39;poc&#39;</span><span class="p">][</span><span class="s">&#39;emails&#39;</span><span class="p">][</span><span class="s">&#39;email&#39;</span><span class="p">]</span>

                            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">emails</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>

                                <span class="n">emails</span> <span class="o">=</span> <span class="p">[</span><span class="n">emails</span><span class="p">]</span>

                            <span class="n">temp</span> <span class="o">=</span> <span class="p">[]</span>

                            <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">emails</span><span class="p">:</span>

                                <span class="n">temp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">[</span><span class="s">&#39;$&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>

                            <span class="n">key</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">_emails&#39;</span> <span class="o">%</span> <span class="n">poc</span><span class="p">[</span><span class="s">&#39;@description&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

                            <span class="n">net</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                                <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">unique_everseen</span><span class="p">(</span><span class="n">temp</span><span class="p">))</span>
                                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="bp">None</span>
                            <span class="p">)</span>

                <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="n">WhoisLookupError</span><span class="p">):</span>

                    <span class="k">pass</span>

            <span class="n">nets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">net</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">nets</span>

    <span class="k">def</span> <span class="nf">_lookup_rws_ripe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The function for retrieving and parsing whois information for a RIPE</span>
<span class="sd">        IP address via HTTP (Whois-RWS).</span>

<span class="sd">        Args:</span>
<span class="sd">            response: The dictionary containing whois information to parse.</span>

<span class="sd">        Returns:</span>
<span class="sd">            List: Dictionaries containing network information which consists</span>
<span class="sd">                of the fields listed in the NIC_WHOIS dictionary. Certain IPs</span>
<span class="sd">                have more granular network listings, hence the need for a list</span>
<span class="sd">                object.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">nets</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">try</span><span class="p">:</span>

            <span class="n">object_list</span> <span class="o">=</span> <span class="n">response</span><span class="p">[</span><span class="s">&#39;objects&#39;</span><span class="p">][</span><span class="s">&#39;object&#39;</span><span class="p">]</span>

        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>

            <span class="n">object_list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">ripe_abuse_emails</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">ripe_misc_emails</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">net</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">BASE_NET</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">object_list</span><span class="p">:</span>

            <span class="k">try</span><span class="p">:</span>

                <span class="k">if</span> <span class="n">n</span><span class="p">[</span><span class="s">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;role&#39;</span><span class="p">:</span>

                    <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">n</span><span class="p">[</span><span class="s">&#39;attributes&#39;</span><span class="p">][</span><span class="s">&#39;attribute&#39;</span><span class="p">]:</span>

                        <span class="k">if</span> <span class="n">attr</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;abuse-mailbox&#39;</span><span class="p">:</span>

                            <span class="n">ripe_abuse_emails</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span>
                                <span class="n">attr</span><span class="p">[</span><span class="s">&#39;value&#39;</span><span class="p">]</span>
                            <span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>

                        <span class="k">elif</span> <span class="n">attr</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;e-mail&#39;</span><span class="p">:</span>

                            <span class="n">ripe_misc_emails</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">attr</span><span class="p">[</span><span class="s">&#39;value&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>

                        <span class="k">elif</span> <span class="n">attr</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;address&#39;</span><span class="p">:</span>

                            <span class="k">if</span> <span class="n">net</span><span class="p">[</span><span class="s">&#39;address&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>

                                <span class="n">net</span><span class="p">[</span><span class="s">&#39;address&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="s">&#39;</span><span class="se">\n</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                    <span class="nb">str</span><span class="p">(</span><span class="n">attr</span><span class="p">[</span><span class="s">&#39;value&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                                <span class="p">)</span>

                            <span class="k">else</span><span class="p">:</span>

                                <span class="n">net</span><span class="p">[</span><span class="s">&#39;address&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">attr</span><span class="p">[</span><span class="s">&#39;value&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

                <span class="k">elif</span> <span class="n">n</span><span class="p">[</span><span class="s">&#39;type&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;inetnum&#39;</span><span class="p">,</span> <span class="s">&#39;inet6num&#39;</span><span class="p">):</span>

                    <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">n</span><span class="p">[</span><span class="s">&#39;attributes&#39;</span><span class="p">][</span><span class="s">&#39;attribute&#39;</span><span class="p">]:</span>

                        <span class="k">if</span> <span class="n">attr</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;inetnum&#39;</span><span class="p">,</span> <span class="s">&#39;inet6num&#39;</span><span class="p">):</span>

                            <span class="n">net</span><span class="p">[</span><span class="s">&#39;range&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">attr</span><span class="p">[</span><span class="s">&#39;value&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                            <span class="n">ipr</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">attr</span><span class="p">[</span><span class="s">&#39;value&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                            <span class="n">ip_range</span> <span class="o">=</span> <span class="n">ipr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39; - &#39;</span><span class="p">)</span>

                            <span class="k">try</span><span class="p">:</span>

                                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ip_range</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>

                                    <span class="n">addrs</span> <span class="o">=</span> <span class="p">[]</span>
                                    <span class="n">addrs</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                                        <span class="n">summarize_address_range</span><span class="p">(</span>
                                            <span class="n">ip_address</span><span class="p">(</span><span class="n">ip_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                                            <span class="n">ip_address</span><span class="p">(</span><span class="n">ip_range</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                                        <span class="p">)</span>
                                    <span class="p">)</span>

                                    <span class="n">cidr</span> <span class="o">=</span> <span class="s">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                                        <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">__str__</span><span class="p">()</span>
                                         <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">collapse_addresses</span><span class="p">(</span><span class="n">addrs</span><span class="p">)]</span>
                                    <span class="p">)</span>

                                <span class="k">else</span><span class="p">:</span>

                                    <span class="n">cidr</span> <span class="o">=</span> <span class="n">ip_network</span><span class="p">(</span><span class="n">ip_range</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">__str__</span><span class="p">()</span>

                                <span class="n">net</span><span class="p">[</span><span class="s">&#39;cidr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cidr</span>

                            <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>

                                <span class="k">pass</span>

                        <span class="k">elif</span> <span class="n">attr</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;netname&#39;</span><span class="p">:</span>

                            <span class="n">net</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">attr</span><span class="p">[</span><span class="s">&#39;value&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

                        <span class="k">elif</span> <span class="n">attr</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;nic-hdl&#39;</span><span class="p">:</span>

                            <span class="n">net</span><span class="p">[</span><span class="s">&#39;handle&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">attr</span><span class="p">[</span><span class="s">&#39;value&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

                        <span class="k">elif</span> <span class="n">attr</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;descr&#39;</span><span class="p">:</span>

                            <span class="k">if</span> <span class="n">net</span><span class="p">[</span><span class="s">&#39;description&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>

                                <span class="n">net</span><span class="p">[</span><span class="s">&#39;description&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="s">&#39;</span><span class="se">\n</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                    <span class="nb">str</span><span class="p">(</span><span class="n">attr</span><span class="p">[</span><span class="s">&#39;value&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                                <span class="p">)</span>

                            <span class="k">else</span><span class="p">:</span>

                                <span class="n">net</span><span class="p">[</span><span class="s">&#39;description&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">attr</span><span class="p">[</span><span class="s">&#39;value&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

                        <span class="k">elif</span> <span class="n">attr</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;country&#39;</span><span class="p">:</span>

                            <span class="n">net</span><span class="p">[</span><span class="s">&#39;country&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">attr</span><span class="p">[</span><span class="s">&#39;value&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>

            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>

                <span class="k">pass</span>

        <span class="n">nets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">net</span><span class="p">)</span>

        <span class="c">#This is nasty. Since RIPE RWS doesn&#39;t provide a granular</span>
        <span class="c">#contact to network relationship, we apply to all networks.</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ripe_abuse_emails</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">ripe_misc_emails</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>

            <span class="n">abuse</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">unique_everseen</span><span class="p">(</span><span class="n">ripe_abuse_emails</span><span class="p">))</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ripe_abuse_emails</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="bp">None</span>
            <span class="p">)</span>
            <span class="n">misc</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">unique_everseen</span><span class="p">(</span><span class="n">ripe_misc_emails</span><span class="p">))</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ripe_misc_emails</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="bp">None</span>
            <span class="p">)</span>

            <span class="k">for</span> <span class="n">net</span> <span class="ow">in</span> <span class="n">nets</span><span class="p">:</span>

                <span class="n">net</span><span class="p">[</span><span class="s">&#39;abuse_emails&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">abuse</span>
                <span class="n">net</span><span class="p">[</span><span class="s">&#39;misc_emails&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">misc</span>

        <span class="k">return</span> <span class="n">nets</span>

    <span class="k">def</span> <span class="nf">_lookup_rws_apnic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The function for retrieving and parsing whois information for a APNIC</span>
<span class="sd">        IP address via HTTP (Whois-RWS).</span>

<span class="sd">        Args:</span>
<span class="sd">            response: The dictionary containing whois information to parse.</span>

<span class="sd">        Returns:</span>
<span class="sd">            List: Dictionaries containing network information which consists</span>
<span class="sd">                of the fields listed in the NIC_WHOIS dictionary. Certain IPs</span>
<span class="sd">                have more granular network listings, hence the need for a list</span>
<span class="sd">                object.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">addrs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">net</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">BASE_NET</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>

            <span class="n">addrs</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">summarize_address_range</span><span class="p">(</span>
                <span class="n">ip_address</span><span class="p">(</span><span class="n">response</span><span class="p">[</span><span class="s">&#39;startAddress&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()),</span>
                <span class="n">ip_address</span><span class="p">(</span><span class="n">response</span><span class="p">[</span><span class="s">&#39;endAddress&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())))</span>

            <span class="n">net</span><span class="p">[</span><span class="s">&#39;cidr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">__str__</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">collapse_addresses</span><span class="p">(</span><span class="n">addrs</span><span class="p">)]</span>
            <span class="p">)</span>

            <span class="n">net</span><span class="p">[</span><span class="s">&#39;range&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">response</span><span class="p">[</span><span class="s">&#39;startAddress&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">+</span> <span class="s">&#39; - &#39;</span> <span class="o">+</span>
                            <span class="n">response</span><span class="p">[</span><span class="s">&#39;endAddress&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>

        <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>

                <span class="k">pass</span>

        <span class="k">try</span><span class="p">:</span>

            <span class="n">net</span><span class="p">[</span><span class="s">&#39;country&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">response</span><span class="p">[</span><span class="s">&#39;country&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>

        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>

            <span class="k">pass</span>

        <span class="k">try</span><span class="p">:</span>

            <span class="n">events</span> <span class="o">=</span> <span class="n">response</span><span class="p">[</span><span class="s">&#39;events&#39;</span><span class="p">]</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">events</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>

                <span class="n">events</span> <span class="o">=</span> <span class="p">[</span><span class="n">events</span><span class="p">]</span>

        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>

            <span class="n">events</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">ev</span> <span class="ow">in</span> <span class="n">events</span><span class="p">:</span>

            <span class="k">try</span><span class="p">:</span>

                <span class="k">if</span> <span class="n">ev</span><span class="p">[</span><span class="s">&#39;eventAction&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;registration&#39;</span><span class="p">:</span>

                    <span class="n">net</span><span class="p">[</span><span class="s">&#39;created&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">ev</span><span class="p">[</span><span class="s">&#39;eventDate&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

                <span class="k">elif</span> <span class="n">ev</span><span class="p">[</span><span class="s">&#39;eventAction&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;last changed&#39;</span><span class="p">:</span>

                    <span class="n">net</span><span class="p">[</span><span class="s">&#39;updated&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">ev</span><span class="p">[</span><span class="s">&#39;eventDate&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

            <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>

                <span class="k">pass</span>

        <span class="k">try</span><span class="p">:</span>

            <span class="n">entities</span> <span class="o">=</span> <span class="n">response</span><span class="p">[</span><span class="s">&#39;entities&#39;</span><span class="p">]</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entities</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>

                <span class="n">entities</span> <span class="o">=</span> <span class="p">[</span><span class="n">entities</span><span class="p">]</span>

        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>

            <span class="n">entities</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">en</span> <span class="ow">in</span> <span class="n">entities</span><span class="p">:</span>

            <span class="k">try</span><span class="p">:</span>

                <span class="k">if</span> <span class="s">&#39;handle&#39;</span> <span class="ow">in</span> <span class="n">en</span><span class="p">:</span>

                    <span class="n">net</span><span class="p">[</span><span class="s">&#39;handle&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">en</span><span class="p">[</span><span class="s">&#39;handle&#39;</span><span class="p">]</span>

                <span class="n">temp</span> <span class="o">=</span> <span class="n">en</span><span class="p">[</span><span class="s">&#39;vcardArray&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>

                <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">temp</span><span class="p">:</span>

                    <span class="k">if</span> <span class="s">&#39;administrative&#39;</span> <span class="ow">in</span> <span class="n">en</span><span class="p">[</span><span class="s">&#39;roles&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;fn&#39;</span><span class="p">:</span>

                        <span class="n">net</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

                    <span class="k">elif</span> <span class="s">&#39;administrative&#39;</span> <span class="ow">in</span> <span class="n">en</span><span class="p">[</span><span class="s">&#39;roles&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;adr&#39;</span><span class="p">:</span>

                        <span class="k">try</span><span class="p">:</span>

                            <span class="n">net</span><span class="p">[</span><span class="s">&#39;address&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s">&#39;label&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

                        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>

                            <span class="k">pass</span>

                    <span class="k">elif</span> <span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;email&#39;</span><span class="p">:</span>

                        <span class="n">key</span> <span class="o">=</span> <span class="bp">None</span>

                        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">en</span><span class="p">[</span><span class="s">&#39;roles&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">or</span>
                           <span class="n">en</span><span class="p">[</span><span class="s">&#39;roles&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;administrative&#39;</span><span class="p">):</span>

                            <span class="n">key</span> <span class="o">=</span> <span class="s">&#39;misc_emails&#39;</span>

                        <span class="k">elif</span> <span class="n">en</span><span class="p">[</span><span class="s">&#39;roles&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;abuse&#39;</span><span class="p">:</span>

                            <span class="n">key</span> <span class="o">=</span> <span class="s">&#39;abuse_emails&#39;</span>

                        <span class="k">elif</span> <span class="n">en</span><span class="p">[</span><span class="s">&#39;roles&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;technical&#39;</span><span class="p">:</span>

                            <span class="n">key</span> <span class="o">=</span> <span class="s">&#39;tech_emails&#39;</span>

                        <span class="k">if</span> <span class="n">key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>

                            <span class="k">if</span> <span class="n">net</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>

                                <span class="n">net</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">+=</span> <span class="s">&#39;</span><span class="se">\n</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

                            <span class="k">else</span><span class="p">:</span>

                                <span class="n">net</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

            <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="ne">IndexError</span><span class="p">):</span>

                <span class="k">pass</span>

        <span class="k">try</span><span class="p">:</span>

            <span class="n">remarks</span> <span class="o">=</span> <span class="n">response</span><span class="p">[</span><span class="s">&#39;remarks&#39;</span><span class="p">]</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">remarks</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>

                <span class="n">remarks</span> <span class="o">=</span> <span class="p">[</span><span class="n">remarks</span><span class="p">]</span>

        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>

            <span class="n">remarks</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">rem</span> <span class="ow">in</span> <span class="n">remarks</span><span class="p">:</span>

            <span class="k">try</span><span class="p">:</span>

                <span class="k">if</span> <span class="n">rem</span><span class="p">[</span><span class="s">&#39;title&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;description&#39;</span><span class="p">:</span>

                    <span class="n">net</span><span class="p">[</span><span class="s">&#39;description&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">rem</span><span class="p">[</span><span class="s">&#39;description&#39;</span><span class="p">]))</span>

            <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="ne">IndexError</span><span class="p">):</span>

                <span class="k">pass</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">net</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_lookup_rws_lacnic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The function for retrieving and parsing whois information for a LACNIC</span>
<span class="sd">        IP address via HTTP (Whois-RWS).</span>

<span class="sd">        Args:</span>
<span class="sd">            response: The dictionary containing whois information to parse.</span>

<span class="sd">        Returns:</span>
<span class="sd">            List: Dictionaries containing network information which consists</span>
<span class="sd">                of the fields listed in the NIC_WHOIS dictionary. Certain IPs</span>
<span class="sd">                have more granular network listings, hence the need for a list</span>
<span class="sd">                object.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">addrs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">net</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">BASE_NET</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>

            <span class="n">addrs</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">summarize_address_range</span><span class="p">(</span>
                <span class="n">ip_address</span><span class="p">(</span><span class="n">response</span><span class="p">[</span><span class="s">&#39;startAddress&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()),</span>
                <span class="n">ip_address</span><span class="p">(</span><span class="n">response</span><span class="p">[</span><span class="s">&#39;endAddress&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())))</span>

            <span class="n">net</span><span class="p">[</span><span class="s">&#39;cidr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">__str__</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">collapse_addresses</span><span class="p">(</span><span class="n">addrs</span><span class="p">)]</span>
            <span class="p">)</span>

            <span class="n">net</span><span class="p">[</span><span class="s">&#39;range&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">response</span><span class="p">[</span><span class="s">&#39;startAddress&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">+</span> <span class="s">&#39; - &#39;</span> <span class="o">+</span>
                            <span class="n">response</span><span class="p">[</span><span class="s">&#39;endAddress&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>

        <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>

                <span class="k">pass</span>

        <span class="k">try</span><span class="p">:</span>

            <span class="n">net</span><span class="p">[</span><span class="s">&#39;country&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">response</span><span class="p">[</span><span class="s">&#39;country&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>

        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>

            <span class="k">pass</span>

        <span class="k">try</span><span class="p">:</span>

            <span class="n">events</span> <span class="o">=</span> <span class="n">response</span><span class="p">[</span><span class="s">&#39;events&#39;</span><span class="p">]</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">events</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>

                <span class="n">events</span> <span class="o">=</span> <span class="p">[</span><span class="n">events</span><span class="p">]</span>

        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>

            <span class="n">events</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">ev</span> <span class="ow">in</span> <span class="n">events</span><span class="p">:</span>

            <span class="k">try</span><span class="p">:</span>

                <span class="k">if</span> <span class="n">ev</span><span class="p">[</span><span class="s">&#39;eventAction&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;registration&#39;</span><span class="p">:</span>

                    <span class="n">tmp</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">ev</span><span class="p">[</span><span class="s">&#39;eventDate&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

                    <span class="n">value</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span>
                        <span class="n">tmp</span><span class="p">,</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">NIC_WHOIS</span><span class="p">[</span><span class="s">&#39;lacnic&#39;</span><span class="p">][</span><span class="s">&#39;dt_rws_format&#39;</span><span class="p">])</span>
                    <span class="p">)</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(</span><span class="s">&#39;T&#39;</span><span class="p">)</span>

                    <span class="n">net</span><span class="p">[</span><span class="s">&#39;created&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

                <span class="k">elif</span> <span class="n">ev</span><span class="p">[</span><span class="s">&#39;eventAction&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;last changed&#39;</span><span class="p">:</span>

                    <span class="n">tmp</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">ev</span><span class="p">[</span><span class="s">&#39;eventDate&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

                    <span class="n">value</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span>
                        <span class="n">tmp</span><span class="p">,</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">NIC_WHOIS</span><span class="p">[</span><span class="s">&#39;lacnic&#39;</span><span class="p">][</span><span class="s">&#39;dt_rws_format&#39;</span><span class="p">])</span>
                    <span class="p">)</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(</span><span class="s">&#39;T&#39;</span><span class="p">)</span>

                    <span class="n">net</span><span class="p">[</span><span class="s">&#39;updated&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

            <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>

                <span class="k">pass</span>

        <span class="k">try</span><span class="p">:</span>

            <span class="n">entities</span> <span class="o">=</span> <span class="n">response</span><span class="p">[</span><span class="s">&#39;entities&#39;</span><span class="p">]</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entities</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>

                <span class="n">entities</span> <span class="o">=</span> <span class="p">[</span><span class="n">entities</span><span class="p">]</span>

        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>

            <span class="n">entities</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">en</span> <span class="ow">in</span> <span class="n">entities</span><span class="p">:</span>

            <span class="k">try</span><span class="p">:</span>

                <span class="k">if</span> <span class="s">&#39;handle&#39;</span> <span class="ow">in</span> <span class="n">en</span><span class="p">:</span>

                    <span class="n">net</span><span class="p">[</span><span class="s">&#39;handle&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">en</span><span class="p">[</span><span class="s">&#39;handle&#39;</span><span class="p">]</span>

                <span class="k">if</span> <span class="n">en</span><span class="p">[</span><span class="s">&#39;roles&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;registrant&#39;</span><span class="p">:</span>

                    <span class="n">temp</span> <span class="o">=</span> <span class="n">en</span><span class="p">[</span><span class="s">&#39;vcardArray&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>

                    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">temp</span><span class="p">:</span>

                        <span class="k">if</span> <span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;fn&#39;</span><span class="p">:</span>

                            <span class="n">net</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

                        <span class="k">elif</span> <span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;org&#39;</span><span class="p">:</span>

                            <span class="n">net</span><span class="p">[</span><span class="s">&#39;description&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

                        <span class="k">elif</span> <span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;adr&#39;</span><span class="p">:</span>

                            <span class="n">net</span><span class="p">[</span><span class="s">&#39;address&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s">&#39;label&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

                        <span class="k">elif</span> <span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;email&#39;</span><span class="p">:</span>

                            <span class="n">net</span><span class="p">[</span><span class="s">&#39;misc_emails&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

                <span class="k">elif</span> <span class="n">en</span><span class="p">[</span><span class="s">&#39;roles&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;abuse&#39;</span><span class="p">:</span>

                    <span class="n">temp</span> <span class="o">=</span> <span class="n">en</span><span class="p">[</span><span class="s">&#39;vcardArray&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>

                    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">temp</span><span class="p">:</span>

                        <span class="k">if</span> <span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;email&#39;</span><span class="p">:</span>

                            <span class="n">net</span><span class="p">[</span><span class="s">&#39;abuse_emails&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

                <span class="k">elif</span> <span class="n">en</span><span class="p">[</span><span class="s">&#39;roles&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;tech&#39;</span><span class="p">:</span>

                    <span class="n">temp</span> <span class="o">=</span> <span class="n">en</span><span class="p">[</span><span class="s">&#39;vcardArray&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>

                    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">temp</span><span class="p">:</span>

                        <span class="k">if</span> <span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;email&#39;</span><span class="p">:</span>

                            <span class="n">net</span><span class="p">[</span><span class="s">&#39;tech_emails&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

            <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="ne">IndexError</span><span class="p">):</span>

                <span class="k">pass</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">net</span><span class="p">]</span>

<div class="viewcode-block" id="IPWhois.lookup_rws"><a class="viewcode-back" href="../../ipwhois.html#ipwhois.ipwhois.IPWhois.lookup_rws">[docs]</a>    <span class="k">def</span> <span class="nf">lookup_rws</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inc_raw</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">retry_count</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The function for retrieving and parsing whois information for an IP</span>
<span class="sd">        address via HTTP (Whois-RWS).</span>

<span class="sd">        **This should be faster than IPWhois.lookup(), but may not be as</span>
<span class="sd">        reliable. AFRINIC does not have a Whois-RWS service yet. We have to</span>
<span class="sd">        rely on the Ripe RWS service, which does not contain all of the data</span>
<span class="sd">        we need. LACNIC RWS is in beta.**</span>

<span class="sd">        Args:</span>
<span class="sd">            inc_raw: Boolean for whether to include the raw whois results in</span>
<span class="sd">                the returned dictionary.</span>
<span class="sd">            retry_count: The number of times to retry in case socket errors,</span>
<span class="sd">                timeouts, connection resets, etc. are encountered.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dictionary:</span>

<span class="sd">            :query: The IP address (String)</span>
<span class="sd">            :asn: The Autonomous System Number (String)</span>
<span class="sd">            :asn_date: The ASN Allocation date (String)</span>
<span class="sd">            :asn_registry: The assigned ASN registry (String)</span>
<span class="sd">            :asn_cidr: The assigned ASN CIDR (String)</span>
<span class="sd">            :asn_country_code: The assigned ASN country code (String)</span>
<span class="sd">            :nets: Dictionaries containing network information which consists</span>
<span class="sd">                of the fields listed in the NIC_WHOIS dictionary. (List)</span>
<span class="sd">            :raw: (Dictionary) - Whois results in Json format if the</span>
<span class="sd">                inc_raw parameter is True.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c">#Initialize the response.</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="c">#Attempt to resolve ASN info via Cymru. DNS is faster, try that first.</span>
        <span class="k">try</span><span class="p">:</span>

            <span class="n">asn_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_asn_dns</span><span class="p">()</span>

        <span class="k">except</span> <span class="p">(</span><span class="n">ASNLookupError</span><span class="p">,</span> <span class="n">ASNRegistryError</span><span class="p">):</span>

            <span class="k">try</span><span class="p">:</span>

                <span class="n">asn_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_asn_whois</span><span class="p">(</span><span class="n">retry_count</span><span class="p">)</span>

            <span class="k">except</span> <span class="p">(</span><span class="n">ASNLookupError</span><span class="p">,</span> <span class="n">ASNRegistryError</span><span class="p">):</span>

                <span class="c">#Lets attempt to get the ASN registry information from ARIN.</span>
                <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_rws</span><span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">NIC_WHOIS</span><span class="p">[</span><span class="s">&#39;arin&#39;</span><span class="p">][</span><span class="s">&#39;url&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">address_str</span><span class="p">),</span>
                    <span class="n">retry_count</span>
                <span class="p">)</span>

                <span class="n">asn_data</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s">&#39;asn_registry&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
                    <span class="s">&#39;asn&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
                    <span class="s">&#39;asn_cidr&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
                    <span class="s">&#39;asn_country_code&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
                    <span class="s">&#39;asn_date&#39;</span><span class="p">:</span> <span class="bp">None</span>
                <span class="p">}</span>

                <span class="k">try</span><span class="p">:</span>

                    <span class="n">net_list</span> <span class="o">=</span> <span class="n">response</span><span class="p">[</span><span class="s">&#39;nets&#39;</span><span class="p">][</span><span class="s">&#39;net&#39;</span><span class="p">]</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">net_list</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>

                        <span class="n">net_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">net_list</span><span class="p">]</span>

                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>

                    <span class="n">net_list</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">net_list</span><span class="p">:</span>

                    <span class="k">try</span><span class="p">:</span>

                        <span class="k">if</span> <span class="n">n</span><span class="p">[</span><span class="s">&#39;orgRef&#39;</span><span class="p">][</span><span class="s">&#39;@handle&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;ARIN&#39;</span><span class="p">,</span> <span class="s">&#39;VR-ARIN&#39;</span><span class="p">):</span>

                            <span class="n">asn_data</span><span class="p">[</span><span class="s">&#39;asn_registry&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;arin&#39;</span>

                        <span class="k">elif</span> <span class="n">n</span><span class="p">[</span><span class="s">&#39;orgRef&#39;</span><span class="p">][</span><span class="s">&#39;@handle&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;RIPE&#39;</span><span class="p">:</span>

                            <span class="n">asn_data</span><span class="p">[</span><span class="s">&#39;asn_registry&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;ripencc&#39;</span>

                        <span class="k">else</span><span class="p">:</span>

                            <span class="n">test</span> <span class="o">=</span> <span class="n">NIC_WHOIS</span><span class="p">[</span><span class="n">n</span><span class="p">[</span><span class="s">&#39;orgRef&#39;</span><span class="p">][</span><span class="s">&#39;@handle&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>
                            <span class="n">asn_data</span><span class="p">[</span><span class="s">&#39;asn_registry&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                                <span class="n">n</span><span class="p">[</span><span class="s">&#39;orgRef&#39;</span><span class="p">][</span><span class="s">&#39;@handle&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                            <span class="p">)</span>

                    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>

                        <span class="k">raise</span> <span class="n">ASNRegistryError</span><span class="p">(</span><span class="s">&#39;ASN registry lookup failed.&#39;</span><span class="p">)</span>

                    <span class="k">break</span>

        <span class="c">#Create the return dictionary.</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">&#39;query&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">address_str</span><span class="p">,</span>
            <span class="s">&#39;nets&#39;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s">&#39;raw&#39;</span><span class="p">:</span> <span class="bp">None</span>
        <span class="p">}</span>

        <span class="c">#Add the ASN information to the return dictionary.</span>
        <span class="n">results</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">asn_data</span><span class="p">)</span>

        <span class="c">#Only fetch the response if we haven&#39;t already.</span>
        <span class="k">if</span> <span class="n">response</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">results</span><span class="p">[</span><span class="s">&#39;asn_registry&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="s">&#39;arin&#39;</span><span class="p">:</span>

            <span class="c">#Retrieve the whois data.</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_rws</span><span class="p">(</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">NIC_WHOIS</span><span class="p">[</span><span class="n">results</span><span class="p">[</span><span class="s">&#39;asn_registry&#39;</span><span class="p">]][</span><span class="s">&#39;url&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">address_str</span><span class="p">),</span>
                <span class="n">retry_count</span>
            <span class="p">)</span>

        <span class="c">#If inc_raw parameter is True, add the response to return dictionary.</span>
        <span class="k">if</span> <span class="n">inc_raw</span><span class="p">:</span>

            <span class="n">results</span><span class="p">[</span><span class="s">&#39;raw&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">response</span>

        <span class="k">if</span> <span class="n">results</span><span class="p">[</span><span class="s">&#39;asn_registry&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;ripencc&#39;</span><span class="p">,</span> <span class="s">&#39;afrinic&#39;</span><span class="p">):</span>

            <span class="n">nets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lookup_rws_ripe</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">results</span><span class="p">[</span><span class="s">&#39;asn_registry&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;arin&#39;</span><span class="p">:</span>

            <span class="n">nets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lookup_rws_arin</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">retry_count</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">results</span><span class="p">[</span><span class="s">&#39;asn_registry&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;apnic&#39;</span><span class="p">:</span>

            <span class="n">nets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lookup_rws_apnic</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="n">nets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lookup_rws_lacnic</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>

        <span class="c">#Add the networks to the return dictionary.</span>
        <span class="n">results</span><span class="p">[</span><span class="s">&#39;nets&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nets</span>

        <span class="k">return</span> <span class="n">results</span></div></div>
</pre></div>

    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
    </p>
    <p>
        &copy; Copyright 2015, Philip Hane.<br/>
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.3b2.<br/>
    </p>
  </div>
</footer>
  </body>
</html>